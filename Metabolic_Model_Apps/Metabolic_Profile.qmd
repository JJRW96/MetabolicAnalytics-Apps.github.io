---
title: "Metabolic Profile"

format:
  html:
    resources: 
      - shinylive-sw.js
      
filters:
  - shinylive

execute:
  message: false
  engine: knitr
  echo: false
  warning: false
  error: false
bibliography: references_all.bib
lang: eng
number-sections: false
editor: 
  markdown: 
    wrap: 72

---

```{css}
#| echo: false
p {
  text-align: justify
}
caption, .figure-caption {
  text-align: left;
}
figure.quarto-float-tbl figcaption {
  text-align: left !important;
}
figure figcaption {
  text-align: justify;
}
```



<div style="position: relative; width: 100%; height: 800px;">
  <iframe src="Metabolic_Profile_App_3.7.6.html" style="position: absolute; width: 100%; height: 100%; border: none;"></iframe>
</div>

<br>

[Fullscreen-Link: Metabolic Profile App](/Metabolic_Profile_App_3.7.6.html)

# Metabolic Profile App: A Feature Guide

The **Integrated Metabolic & Power Profile** application is an advanced, web-based tool designed to unify two critical domains of performance physiology: the underlying metabolic framework of an athlete and their maximal power-duration capabilities. It achieves this by synergistically combining a metabolic model, based on the principles established by Alois Mader [@Mader2003], with a suite of established power-duration models. This integration allows for a comprehensive, multi-faceted analysis of an athlete's physiological profile, providing insights that extend far beyond what either model could offer in isolation.

The application operates through an interactive interface, allowing users to:

1.  **Define a detailed physiological profile:** Users can input or estimate fundamental metabolic parameters like maximal oxygen uptake ($\dot{V}O_{2,max}$), maximal glycolytic rate ($vLa_{max}$), and exercise efficiency (CE).
2.  **Model the Power-Duration Profile (PDP):** Users can input real-world maximal effort data points (e.g., from training or races) and fit them using a selection of mathematical models to characterize performance across a wide range of durations.
3.  **Visualize Integrated Results:** The app generates a series of interconnected plots and data tables, including a metabolic profile, a power-duration curve, a substrate utilization breakdown, a comparative radar chart, and personalized training zones.
4.  **Compare Multiple Profiles:** A dedicated comparison mode enables the side-by-side analysis of different athletes or different physiological states of the same athlete, using standardized metrics and visualizations.

## Core Concepts: The Union of Two Model Worlds

The application's strength lies in its ability to bridge the gap between two complementary modeling approaches:

*   **The Metabolic Model:** This "bottom-up" model simulates an athlete's physiological state based on fundamental parameters. It calculates steady-state oxygen uptake, lactate production and clearance rates, and substrate utilization to predict key metabolic thresholds like the **Maximal Lactate Steady State (MLSS)** and the point of maximal fat oxidation (**FAT~max~**). This model answers the question: "Given this athlete's specific engine characteristics, what are their metabolic responses at various intensities?"

*   **The Power-Duration (PD) Model:** This "top-down" approach characterizes an athlete's performance capabilities based on their actual maximal efforts. By fitting a mathematical curve to these data points, it can interpolate or extrapolate the maximal sustainable power for any duration and derive parameters like **Critical Power (CP)** and **W'** (anaerobic work capacity). This model answers the question: "Based on their performances, what are this athlete's functional threshold and anaerobic capacity?"

The app not only presents these models side-by-side but also provides tools to link them—for instance, by estimating $\dot{V}O_{2,max}$ from the PD model or by fitting a metabolic parameter (like $vLa_{max}$) to align the predicted MLSS with the PD-derived Critical Power.

## The Sidebar: The Control Center

The sidebar is the primary interface for controlling all model parameters and settings, logically organized into tabs.

### Tab 1: Settings & Profile

This is the main tab for defining the athlete's profile and configuring the underlying models.

#### **Athlete & Profile Management**

This section allows for the creation, selection, and management of athlete profiles.

*   **Athlete Profile Dropdown:** Select from a list of pre-defined example profiles (e.g., "T. Pogačar", ...) or custom profiles that have been added or imported. Selecting a profile loads all its associated physiological parameters and power data.
*   **Import/Export/Add Profile:**
    *   **Import Profile:** Loads a complete athlete profile from a local `.json` file. The app intelligently handles missing data by applying sensible defaults or calculating parameters where possible (e.g., calculating $\dot{V}O_{2,Base}$ from anthropometrics if it's not in the file).
    *   **Export Profile:** Saves the *currently displayed custom profile* to a `.json` file. This includes all settings, physiological parameters, and power data points. Note: Pre-defined athlete profiles are protected and cannot be exported.
    *   **Add Profile:** Prompts the user for a name and creates a new, blank profile with default 'Well-Trained' settings, ready for customization.
*   **Enable Comparison Mode:** This toggle switches the entire application into a multi-profile comparison view (see Tab 3).
*   **Experience Level Presets:** These buttons (Pro, Well-Trained, Beginner) provide a quick way to apply typical metabolic settings. They primarily adjust the **Cost of Exercise (CE)** and the **duration used for $\dot{V}O_{2,max}$ estimation**, reflecting known differences in efficiency and fatigue resistance between athlete populations.
    *   **Pro:** CE = 11.5 ml·min⁻¹·W⁻¹, $\dot{V}O_{2,max}$ Calc. Duration = 6:00 min
    *   **Well-Trained:** CE = 11.7 ml·min⁻¹·W⁻¹, $\dot{V}O_{2,max}$ Calc. Duration = 4:00 min
    *   **Beginner:** CE = 11.9 ml·min⁻¹·W⁻¹, $\dot{V}O_{2,max}$ Calc. Duration = 3:30 min

#### **Power-Duration Modeling**

This crucial section configures how the athlete's performance data is modeled.

*   **Power-Duration Model (Dropdown):** Selects the mathematical model used to fit the power data points.

    *   **2-Parameter CP (Hyperbolic):** The classic model where power is the sum of a sustainable component (CP) and an unsustainable component (W') that depletes over time [@Monod1965].
        $$ P(t) = CP + \frac{W'}{t} $$
        *   **Pros:** Well-established; the parameters are physiologically interpretable (CP as a metabolic threshold, W' as anaerobic work capacity).
        *   **Cons:** Unrealistic for very short durations (predicts infinite power as t→0) and very long durations (predicts no fatigue below CP).
        *   **Data:** Best suited for efforts in the "severe" intensity domain, typically from 2 to 20 minutes. Requires 3-5 reliable data points for a robust fit [@Leo2022].

    *   **Omni-Domain (OmPD):** A 4-parameter extension of the 2P-CP model, designed for a more realistic fit across a wider range of durations, including prolonged endurance [@Puchowicz2020]. It adds a maximal power parameter ($P_{max}$) to anchor the short end of the curve and a fatigue parameter (A) to model the performance decline during very long efforts.
        $$ P(t) = 
        \begin{cases} 
        \frac{W'_{\text{eff}}(t)}{t} + CP & \text{if } t \le 1800s \\
        \frac{W'_{\text{eff}}(t)}{t} + CP - A \cdot \ln(\frac{t}{1800}) & \text{if } t > 1800s
        \end{cases}
        $$
        Where $W'_{\text{eff}}(t) = W' \cdot (1 - e^{-t/\tau})$ and $\tau = W' / (P_{max} - CP)$.
        *   **Pros:** Aims to model the entire power curve, from sprints to ultra-endurance.
        *   **Cons:** More complex; requires more data points (≥4, including efforts >30 min) for a stable fit.
        *   **Virtual Points:** To improve stability, the app automatically adds a virtual 20s data point (based on the "Best 20s Avg. Power" input) if no real data exists in the 1-35s range when this model is selected.

    *   **Power-Law:** A simple, robust 2-parameter model where power is a power function of time.
        $$ P(t) = S \cdot t^{E-1} $$
        *   **Pros:** Often provides an excellent mathematical fit across all durations with as few as two data points.
        *   **Cons:** The parameters (S and E) are less directly interpretable as physiological thresholds compared to CP and W'.

*   **Advanced Model Options (Toggle):** Hides or shows more detailed controls for fine-tuning the model fitting process.
    *   **W'<sub>max</sub> Constraint (Slider):** (Affects 2P-CP and OmPD models) Sets a physiological upper limit on the calculated W' value (in kJ·kg⁻¹), preventing unrealistically high W' estimates, especially with sparse or noisy data. The tooltip provides typical ranges for different athlete types (e.g., Climbers ~0.20 kJ/kg, Sprinters >0.40 kJ/kg).
    *   **Fitting Time Range (Dual-handle Slider):** Allows the user to manually select the specific duration range of data points to be included in the model fitting process. This is useful for excluding outliers or focusing the fit on a specific physiological domain (e.g., the severe domain for a more accurate CP estimate).
    *   **Fitting Method (Dropdown):** Determines the mathematical error minimization strategy for non-linear models.
        *   **Standard (SSE):** Minimizes the sum of squared errors. Good for balanced data but can be dominated by high-power sprint values.
        *   **Weighted (by Duration):** Gives more weight to longer-duration efforts, improving the stability and accuracy of the CP estimate.
        *   **Relative Error (%):** Minimizes percentage error, balancing the influence of high-power sprints and lower-power endurance efforts.
    *   **Add/Control 1s Virtual P<sub>max</sub> (Toggle & Slider):** When enabled, this adds a virtual 1-second data point to the fitting process. The slider sets its power value. This is a powerful tool for anchoring the high end of the power curve for all models, improving the fit for very short durations.

#### **Metabolic Profile Setup (Mader Model)**

This is the core of the metabolic modeling, where the athlete's "engine" is defined.

*   **Oxygen Demand Settings:** Defines the Power-$\dot{V}O_2$ relationship.
    *   **Curvilinear CE relationship (Toggle):** Switches between a linear model and a more physiologically nuanced quadratic model for $\dot{V}O_2$ demand.
        *   **Linear Model:** $\dot{V}O_{2,SS} = CE \cdot P + \dot{V}O_{2,Base}$. A constant oxygen cost per Watt.
        *   **Curvilinear Model:** $\dot{V}O_{2,SS} = a \cdot P^2 + CE_{Start} \cdot P + \dot{V}O_{2,Base}$. Models the decrease in efficiency at higher intensities. The curvature parameter 'a' is automatically calculated to ensure the slope at $\dot{V}O_{2,max}$ matches the user-defined $CE_{Target}$.
    *   **Efficiency Display (η<sub>gross</sub>, η<sub>net</sub>, Δη):** This area displays three key, dynamically calculated efficiency metrics.
        *   **Gross Efficiency (η<sub>gross</sub>):** Ratio of mechanical power output to *total* metabolic energy expenditure.
        *   **Net Efficiency (η<sub>net</sub>):** Ratio of mechanical power output to metabolic energy expenditure *above resting* levels.
        *   **Delta Efficiency (Δη):** Efficiency of performing *additional* mechanical work, calculated from the Cost of Exercise (CE).

*   **Physiological Inputs:** The sliders for setting the athlete's core parameters.
    *   **$\dot{V}O_{2,max}$ (Slider & Auto-Calculation):** Maximal oxygen uptake. Can be set manually or automatically calculated from the power profile using one of three methods:
        1.  **@Sitko2022 formula:** A regression equation based on 5-minute maximal power.
            $$ \dot{V}O_{2,max,rel} = 16.6 + (8.87 \cdot P_{max,5min,rel}) $$
        2.  **CE-based formula:** Estimates $\dot{V}O_{2,max}$ from the oxygen demand of a maximal effort of a user-defined duration (set via the "Duration for $\dot{V}O_{2,max}$ Calc" slider).
            $$ \dot{V}O_{2,max,abs} = (P_{max,duration,abs} \cdot CE) + \dot{V}O_{2,Base} $$
        3.  **Average:** Averages the results of the @Sitko2022 and CE-based methods.
    *   **vLa<sub>max</sub> (Slider & Auto-Calculation):** This parameter represents the maximal rate of lactate production, a key indicator of an athlete's maximal glycolytic capacity. It can be set manually via the slider or automatically estimated using the **"Estimate vLa<sub>max</sub> from 20s Power"** feature. This estimation tool leverages a 20-second maximal sprint power value, a practical field-based proxy for assessing glycolytically dominant power output. The app implements regression equations adapted from research by Clark and Macdermid to derive $vLa_{max}$ from this power input [@Clark2021; @Clark2025]. Users can choose from three estimation methods via a dropdown menu:

        1.  **Method: Absolute (W only):** This method uses the absolute 20-second average power ($P_{20s, abs}$ in Watts) as the sole predictor. The formula implemented is:
        $$ vLa_{max} = 0.062773 + (0.000483 \cdot P_{20s, abs}) $$
        This approach is useful when comparing athletes or tests where absolute power output is the primary metric of interest, independent of body mass.
      2.  **Method: Relative (W/kg only):** This method uses the mass-relative 20-second average power ($P_{20s, rel}$ in W·kg⁻¹), normalizing for the athlete's body mass. The formula is:
        $$ vLa_{max} = -0.402955 + (0.071581 \cdot P_{20s, rel}) $$
        This approach is often preferred for comparing the glycolytic capacity of athletes of different sizes, as it accounts for the influence of body mass on power production.
      3.  **Method: Average (W & W/kg) (Default):** This method calculates $vLa_{max}$ using both the absolute and relative power formulas and then takes the average of the two results. This hybrid approach aims to balance the perspectives of absolute power output and mass-relative capacity, potentially providing a more robust estimate across a wider range of athlete types.
        $$ vLa_{max, final} = \frac{vLa_{max, abs} + vLa_{max, rel}}{2} $$
    The "Best 20s Avg. Power" slider allows the user to input the power value for these calculations, and pressing the "Estimate" button applies the selected formula, updates the main $vLa_{max}$ slider, and triggers a full recalculation of the metabolic profile. This feature provides a valuable, non-invasive method for estimating a key anaerobic parameter from a simple, repeatable performance test.
    
    *   **Fit Parameter to Power Profile (Tool):** A powerful integration feature. It algorithmically adjusts one metabolic parameter ($\dot{V}O_{2,max}$, $vLa_{max}$, or CE) to make the Mader model's predicted MLSS power match 95% of the Critical Power (CP) derived from the 2-Parameter PD model. This provides a physiologically plausible way to anchor the metabolic model to real-world performance data.

#### **Substrate Utilization**

*   **Show Substrate Utilization (Toggle):** Enables the modeling and visualization of fuel use (carbohydrates vs. fats).
*   **Model Basis:** The app calculates the percentage contribution of carbohydrates based on the ratio of lactate production to lactate oxidation ($vLa_{SS} / vLa_{ox}$). As intensity rises, this ratio increases, reflecting a shift towards CHO metabolism. Fat utilization is the remainder. This creates a self-consistent system where the predicted substrate mix determines the Respiratory Quotient (RQ), which in turn determines the precise caloric equivalent of oxygen used for all efficiency calculations.

### Tab 2: Power Data Points

A simple interface for managing the athlete's performance data. Users can input a label, power (in W or W·kg⁻¹, depending on the global unit setting), and duration for their maximal efforts. These points form the basis for the power-duration model fitting.

### Tab 3: Compare

When "Enable Comparison Mode" is checked, this tab becomes active, transforming the app into a powerful multi-profile analysis tool.

*   **Profile Selection:** Users can select multiple profiles to compare simultaneously.
*   **Mirrored Settings:** The tab contains an independent set of controls for the Power-Duration model, allowing users to apply a consistent fitting methodology (e.g., same model, same fitting range) to all selected profiles for a fair comparison.
*   **Etalon Profile Conversion:** A unique feature that converts all athlete profiles to a standardized "Etalon" (60 kg rider, 7.2 kg bike) by using a physics model to calculate the power this standard rider would need to produce to match the actual athlete's speed on a given gradient. This normalizes for differences in body mass and allows for a more direct comparison of climbing performance.

## The Main Content Area: Visualizations & Outputs

This is where the results of the models are displayed through a series of interconnected plots and tables.

#### **Power-Duration Profile (PDP) Plot**

This plot visualizes the athlete's performance data and the fitted PD model.

*   **Data Points:** Plotted as markers. Points used in the fit are solid, while unused points are marked with an 'x'. Virtual points are shown as stars. Markers are color-coded based on their deviation from the fitted model line, providing an instant visual cue for how well the model represents each effort.
*   **Model Curve:** The selected PD model (2P-CP, Power-Law, or OmPD) is drawn as a solid line through the range of the fitted data points and as a dashed line where it is extrapolated.
*   **Annotations:** Key parameters from the fitted model (e.g., CP, W', S, E, R²) and the resulting V̇O₂max estimations are displayed directly on the plot.

#### **Metabolic Profile (Mader Model) Plot**

This plot illustrates the steady-state metabolic responses based on the defined physiological profile.

*   **Axes:** Power (X-axis), $\dot{V}O_2$ (left Y-axis), and Lactate/Metabolic Rates (right Y-axis). A third Y-axis for absolute substrate rates appears if enabled.
*   **Traces:** Displays key curves like $\dot{V}O_{2,SS}$, lactate production ($vLa_{SS}$), lactate oxidation ($vLa_{ox}$), and the resulting Pyruvate Deficit (PD).
*   **Annotations:** Vertical lines and text mark the crucial metabolic thresholds of **FAT<sub>max</sub>** (power at maximal pyruvate deficit) and **MLSS** (power where PD is zero).

#### **Substrate Utilization Plot**

This plot, visible when enabled, shows the relative contribution of carbohydrates and fats to total energy expenditure across the power spectrum, clearly visualizing the "substrate crossover" point.

#### **Key Metrics & Radar Chart**
This section in the bottom row provides a summary and a powerful comparative visualization.

*   **Values Container:** A numerical summary of the key metabolic parameters (Power, $\dot{V}O_2$, Substrate Use, Efficiency) at the FAT<sub>max</sub> and MLSS intensities.
*   **Radar Chart:** A heptagonal plot comparing the athlete's modeled power at seven key durations (5s, 30s, 1m, 3m, 5m, 20m, 60m) against normative data. The outer ring (100%) represents the 90th percentile of professional cyclists [@Mateo-March2022], while the center (0%) represents an untrained individual [@Allen2010]. This provides an at-a-glance view of the athlete's strengths and weaknesses relative to established benchmarks.

#### **Training Zones Tables**
The app generates two detailed tables to guide training prescription.

*   **Training Zones (7 Zone Model):** A classic 7-zone table where power zones are defined as percentages of the Mader-derived MLSS. For each zone, it provides the power range (in %MLSS and absolute Watts), the corresponding heart rate range (based on %HRmax), and the estimated carbohydrate and fat utilization rates (in g/h).
*   **Specific Training Areas:** This table provides more targeted training recommendations for key physiological adaptations. It defines specific interval and rest power targets for workouts aimed at improving **FAT<sub>max</sub>**, **Lactate Clearance**, and **$\dot{V}O_{2,max}$ (via intermittent exercise)**.

#### **Comparison Results (Visible in Compare Mode)**
When in comparison mode, the main content area is replaced by a detailed results table and a combined PDP plot.

*   **Comparison Table:** A comprehensive table listing key metabolic and performance metrics for each selected profile, allowing for direct quantitative comparison. Metrics include $\dot{V}O_{2,max}$, $vLa_{max}$, Pmax at various durations, CP, MLSS, FAT<sub>max</sub>, and a calculated "Compound Score" ($P_{5min,abs} \times P_{5min,wkg}$) for an integrated performance measure. The table is sortable by any column.
*   **Model Details:** Below the table, a summary of the fitted model parameters and the mathematical formula is provided for each profile.
*   **Combined PDP Plot:** All selected profiles' data points and fitted model curves are plotted on a single graph, with each profile assigned a distinct color for clear visual comparison.