<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cycling Power Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Root variables for color scheme & Components */
        :root {
            --primary-color: #2683C6; /* General UI blue */
            --secondary-color: #9C85C0; /* Lighter accent */
            --accent-color: #EF5350;    /* Reddish accent */
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-color: #dee2e6;
            --gradient-start: #f1f8ff;
            --gradient-end: #ffffff;
        }

        /* Base styles */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f5f5f5; color: var(--dark-color); line-height: 1.6; overflow: hidden; }
        .container { display: flex; height: 100vh; max-width: 100%; }

        /* Sidebar */
        .sidebar { width: 350px; flex-shrink: 0; background: linear-gradient(to bottom, var(--gradient-start), var(--gradient-end)); padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); overflow-y: auto; border-right: 1px solid var(--border-color); max-height: 100vh; position: relative; z-index: 10; }
        .sidebar h1 { font-size: 1.5rem; color: var(--primary-color); margin-bottom: 20px; text-align: center; font-weight: 500; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }

        /* Main Content */
        .main-content { flex: 1; padding: 25px; display: flex; flex-direction: column; background-color: #fff; overflow-y: auto; max-height: 100vh; }
        .main-content h2 { font-size: 1.4rem; color: var(--dark-color); margin-bottom: 15px; margin-top: 10px; text-align: center; font-weight: 500;}
        .main-content h3 { font-size: 1.1rem; color: var(--primary-color); margin-bottom: 15px; text-align: center; font-weight: 500;}

        /* Controls in Sidebar */
        .control-group { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); background-color: white; border-radius: 6px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .control-group:last-child { border-bottom: none; margin-bottom: 0; }
        .slider-container { margin-bottom: 15px; }
        .slider-label { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 5px; font-size: 0.9rem; font-weight: 500; }
        .slider-label label { flex-grow: 1; margin-right: 10px; }
        .slider-value { min-width: 85px; text-align: right; font-weight: bold; color: var(--primary-color); font-size: 0.9rem; }
        .range-slider { -webkit-appearance: none; width: 100%; height: 8px; border-radius: 5px; background: #ddd; outline: none; margin-top: 5px; cursor: pointer; }
        .range-slider::-webkit-slider-runnable-track { height: 8px; background: linear-gradient(to right, var(--secondary-color), var(--primary-color)); border-radius: 5px; }
        .range-slider::-moz-range-track { height: 8px; background: linear-gradient(to right, var(--secondary-color), var(--primary-color)); border-radius: 5px; }
        .range-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--primary-color); cursor: pointer; margin-top: -5px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .range-slider::-moz-range-thumb { width: 18px; height: 18px; border-radius: 50%; background: var(--primary-color); cursor: pointer; border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .readonly-display { width:100%; text-align:right; background-color: #e9ecef; border: 1px solid #ccc; padding: 5px 8px; border-radius: 4px; font-weight:bold; color: var(--primary-color); font-size: 0.9rem; margin-top: 5px;}
        .small-note { display: block; text-align: right; font-size: 0.8rem; color: #666; }

        /* Output Area */
        .output-area { background-color: var(--light-color); padding: 12px 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--border-color); }
        .output-area h3 { margin-top: 0; font-size: 1rem; }
        .output-area p { margin: 4px 0; font-size: 0.95em; display: flex; justify-content: space-between; align-items: baseline; flex-wrap: wrap; }
        .output-area .label { color: #333; margin-right: 10px; }
        .output-area .value { color: var(--dark-color); font-weight: 600; min-width: 100px; text-align: right; }
        .output-area .unit { font-size: 0.9em; color: #555; margin-left: 5px;}

        /* Bar Chart Container */
        #powerBarChartContainer { min-height: 350px; height: 24vh; width: 100%; background-color: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); padding: 15px; margin-bottom: 30px; }

        /* Line Plot Containers */
         #plotCurrentGradientWrapper { height: 42vh; min-height: 400px; width: 100%; background-color: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); padding: 15px; margin-bottom: 30px; }
        .fixed-plots-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .plot-wrapper { background-color: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); padding: 15px; display: flex; flex-direction: column; min-height: 360px; }
        .plot-wrapper h4 { text-align: center; margin-bottom: 15px; font-weight: 500; color: var(--dark-color); }
        .plot-canvas { flex-grow: 1; max-height: 400px; width: 100%; }

        /* Explanation Sections */
        .explanation-section {
            background-color: var(--light-color);
            padding: 15px 20px;
            border-radius: 8px;
            margin-top: 10px; /* Space above this section */
            margin-bottom: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }
        .explanation-section h3 {
            font-size: 1.1rem;
            color: var(--primary-color);
            margin-bottom: 10px;
            text-align: center;
            font-weight: 500;
        }
        .explanation-section p {
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 8px;
        }
         .explanation-section strong {
             font-weight: 500;
             color: var(--dark-color);
         }
         .explanation-section ul {
            list-style-position: inside; /* Bullets inside the text block */
            padding-left: 10px; /* Indent list */
            margin-top: 5px;
         }
         .explanation-section li {
            margin-bottom: 5px;
         }
         .explanation-section .formula-inline { /* Style for inline formulas */
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.95em;
            background-color: #e9ecef;
            padding: 1px 3px;
            border-radius: 3px;
         }

        /* General Input Group Styling (for calculators) */
        .input-group { margin-bottom: 15px; display: flex; flex-wrap: wrap; align-items: center; }
        .input-group label { flex-basis: 180px; margin-right: 10px; font-weight: 500; font-size: 0.9rem; }
        .input-group input[type="number"], .input-group input[type="text"], .input-group input[type="file"] { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; min-width: 100px; font-size: 0.9rem; }
        .input-group input[type="file"] { padding: 5px; }
        .input-group span.unit { margin-left: 10px; font-style: italic; color: #555; font-size: 0.85rem; }
        .input-group .info { font-size: 0.85em; color: #666; width: 100%; margin-top: 5px; }

        /* Button */
        button { display: block; width: 100%; padding: 10px 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 4px; font-size: 1em; cursor: pointer; transition: background-color 0.3s ease; margin-top: 15px; }
        button:hover { background-color: #1a6eae; }
        button:disabled { background-color: #aaa; cursor: not-allowed;}

        /* Calculator Sections */
        .calculator-section { background-color: var(--light-color); padding: 20px; border-radius: 8px; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid var(--border-color); margin-bottom: 25px;}
        .calculator-section h3 { margin-top: 0; }
        .calculator-output { margin-top: 20px; padding: 15px; background-color: #e9ecef; border-radius: 5px; font-size: 0.9rem; }
        .calculator-output p { margin: 5px 0; display: flex; justify-content: space-between; }
        .calculator-output strong { font-weight: bold; min-width: 80px; text-align: right; }

        /* Scrollbar Customization */
        .sidebar::-webkit-scrollbar, .main-content::-webkit-scrollbar { width: 8px; }
        .sidebar::-webkit-scrollbar-track, .main-content::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .sidebar::-webkit-scrollbar-thumb, .main-content::-webkit-scrollbar-thumb { background: #bbb; border-radius: 10px; }
        .sidebar::-webkit-scrollbar-thumb:hover, .main-content::-webkit-scrollbar-thumb:hover { background: #999; }

        /* Spinner */
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--primary-color); width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-left: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
             <h1>Power Calculator</h1>
             <div class="control-group">
                 <div class="slider-container">
                     <div class="slider-label">
                         <label for="velocity">Speed:</label>
                         <span id="velocity-value" class="slider-value">30.0 km/h</span>
                     </div>
                     <input type="range" id="velocity" class="range-slider" min="0.1" max="70" value="30" step="0.1">
                 </div>
                 <div class="slider-container">
                     <div class="slider-label">
                         <label for="riderMass">Rider Mass:</label>
                         <span id="riderMass-value" class="slider-value">70.0 kg</span>
                     </div>
                     <input type="range" id="riderMass" class="range-slider" min="30" max="120" value="70" step="0.5">
                 </div>
                  <div class="slider-container">
                     <div class="slider-label">
                         <label for="bikeMass">Bike Mass:</label>
                         <span id="bikeMass-value" class="slider-value">9.0 kg</span>
                     </div>
                     <input type="range" id="bikeMass" class="range-slider" min="1" max="20" value="9" step="0.1">
                 </div>
                 <div class="slider-container">
                     <div class="slider-label">
                         <label for="totalMass">Total Mass (m<sub>T</sub>):</label>
                         <span id="totalMass-value" class="slider-value">79.0 kg</span>
                     </div>
                     <input type="text" id="totalMass" value="79.0 kg" readonly class="readonly-display">
                 </div>
             </div>
             <div class="control-group">
                 <div class="slider-container">
                     <div class="slider-label">
                         <label for="gradient">Gradient:</label>
                         <span id="gradient-value" class="slider-value">0.0 %</span>
                     </div>
                     <input type="range" id="gradient" class="range-slider" min="-15" max="20" value="0" step="0.1">
                 </div>
                 <div class="slider-container">
                     <div class="slider-label">
                         <label for="windSpeed">Wind Speed:</label>
                         <span id="windSpeed-value" class="slider-value">0.0 km/h</span>
                     </div>
                     <input type="range" id="windSpeed" class="range-slider" min="-50" max="50" value="0" step="0.5">
                     <small class="small-note">(positive=tailwind, negative=headwind)</small>
                 </div>
             </div>
             <div class="control-group">
                  <div class="slider-container">
                     <div class="slider-label">
                         <label for="cdA">Drag Area (C<sub>d</sub>A):</label>
                         <span id="cdA-value" class="slider-value">0.270 m²</span>
                     </div>
                     <input type="range" id="cdA" class="range-slider" min="0.15" max="0.5" value="0.27" step="0.001">
                 </div>
                 <div class="slider-container">
                     <div class="slider-label">
                         <label for="crr">Rolling Resistance (C<sub>rr</sub>):</label>
                         <span id="crr-value" class="slider-value">0.0030</span> </div>
                     <input type="range" id="crr" class="range-slider" min="0.0020" max="0.0080" value="0.0030" step="0.0001">
                     <small class="small-note">Baseline value under test conditions. See explanation below.</small> </div>
                 <div class="slider-container">
                     <div class="slider-label">
                         <label for="airDensity">Air Density (ρ):</label>
                         <span id="airDensity-value" class="slider-value">1.225 kg/m³</span>
                     </div>
                     <input type="range" id="airDensity" class="range-slider" min="0.95" max="1.35" value="1.225" step="0.001">
                 </div>
             </div>
              <p style="font-size: 0.8em; color: #666; text-align: center; margin-top: 15px;">Model based on <a href="https://journals.humankinetics.com/view/journals/jab/14/3/article-p276.xml" target="_blank" title="Link to Martin et al. (1998) Paper">Martin et al. (1998)</a></p>
        </div>

        <div class="main-content">
              <div class="output-area">
                  <h3>Power Overview (at selected speed & gradient)</h3>
                  <p>
                      <span class="label">Required Total Power (P<sub>TOT</sub>):</span>
                      <span class="value"><span id="totalPower">---</span><span class="unit">W</span></span>
                  </p>
                   <p>
                       <span class="label">Power per kg Rider Mass:</span>
                       <span class="value"><span id="powerPerKg">---</span><span class="unit">W/kg</span></span>
                   </p>
                   <hr style="border-color: #ccc; margin: 10px 0;">
                   <p>
                       <span class="label">Aerodynamic Drag (P<sub>AT</sub>):</span>
                       <span class="value"><span id="powerAero">---</span><span class="unit">W</span></span>
                   </p>
                   <p>
                       <span class="label">Rolling Resistance (P<sub>RR</sub>):</span>
                       <span class="value"><span id="powerRolling">---</span><span class="unit">W</span></span>
                   </p>
                   <p>
                       <span class="label">Potential Energy (P<sub>PE</sub>):</span>
                       <span class="value"><span id="powerPotential">---</span><span class="unit">W</span></span>
                   </p>
                   <p>
                       <span class="label">Mechanical Losses (P<sub>WB</sub> + P<sub>C</sub>):</span>
                       <span class="value"><span id="powerMechanical">---</span><span class="unit">W</span></span>
                  </p>
             </div>

             <div id="powerBarChartContainer">
                 <canvas id="powerBarChart"></canvas>
             </div>

             <div id="plotCurrentGradientWrapper" class="plot-wrapper">
                   <h4>Power Components vs Speed (at <span id="currentGradientLabel">0.0</span>% Gradient, Wind: <span id="currentWindLabel">0.0</span> km/h)</h4>
                   <canvas id="plotCurrentGradient" class="plot-canvas"></canvas>
             </div>

             <h2>Power vs. Speed Analysis (Fixed Gradients)</h2>

              <div class="fixed-plots-container">
                   <div class="plot-wrapper">
                       <h4>Gradient: -5%</h4>
                       <canvas id="plotGradientMinus5" class="plot-canvas"></canvas>
                   </div>
                   <div class="plot-wrapper">
                       <h4>Gradient: 0%</h4>
                       <canvas id="plotGradientZero" class="plot-canvas"></canvas>
                   </div>
                   <div class="plot-wrapper">
                       <h4>Gradient: +5%</h4>
                       <canvas id="plotGradientPlus5" class="plot-canvas"></canvas>
                   </div>
             </div>

            <div class="explanation-section">
                <h3>How Power Components Scale with Speed & Gradient</h3>
                <p>
                    The total power a cyclist needs to produce (<span class="formula-inline">P<sub>TOT</sub></span>, Total Power) is the sum of several components required to overcome different resistive forces. Understanding how these components change with speed (<span class="formula-inline">V<sub>G</sub></span>, Ground Speed) and road gradient (<span class="formula-inline">G<sub>R</sub></span>, rise/run) is key to cycling performance (based on Martin et al., 1998):
                </p>
                <ul>
                    <li>
                        <strong>Aerodynamic Power (<span class="formula-inline">P<sub>AT</sub></span>):</strong> This is the power needed to overcome air resistance (drag). It depends strongly on the relative air velocity (<span class="formula-inline">V<sub>a</sub></span>, the speed of air passing the rider, including wind) and the rider's ground speed (<span class="formula-inline">V<sub>G</sub></span>).
                        Mathematically, aerodynamic <em>force</em> (<span class="formula-inline">F<sub>D</sub></span>) is proportional to the square of air velocity (<span class="formula-inline">F<sub>D</sub> ∝ V<sub>a</sub>²</span>). Since power is force multiplied by velocity, aerodynamic power is calculated as <span class="formula-inline">P<sub>AT</sub> = F<sub>D</sub> * V<sub>G</sub></span>. Therefore, <span class="formula-inline">P<sub>AT</sub></span> is proportional to <span class="formula-inline">V<sub>a</sub>² * V<sub>G</sub></span>.
                        In calm wind conditions, air velocity is approximately equal to ground speed (<span class="formula-inline">V<sub>a</sub> ≈ V<sub>G</sub></span>). Substituting this gives <span class="formula-inline">P<sub>AT</sub> ∝ V<sub>G</sub>² * V<sub>G</sub> = V<sub>G</sub>³</span>. This <strong>cubic relationship</strong> means aerodynamic power increases very rapidly with speed, quickly becoming the dominant resistance at higher speeds on flat ground.
                    </li>
                    <li>
                        <strong>Rolling Resistance Power (<span class="formula-inline">P<sub>RR</sub></span>):</strong> This power overcomes the friction between the tires and the road surface. It is calculated approximately as <span class="formula-inline">P<sub>RR</sub> ≈ V<sub>G</sub> * C<sub>RR</sub> * m<sub>T</sub> * g</span>, where <span class="formula-inline">C<sub>RR</sub></span> is the Coefficient of Rolling Resistance (depends on tires, pressure, surface), <span class="formula-inline">m<sub>T</sub></span> is the Total Mass (rider + bike), and <span class="formula-inline">g</span> is the acceleration due to Gravity (approx. 9.81 m/s²). This means rolling resistance power increases <strong>linearly with ground speed (<span class="formula-inline">V<sub>G</sub></span>)</strong>. While significant, its relative contribution to total power decreases as speed increases compared to aerodynamic drag.
                    </li>
                    <li>
                        <strong>Potential Energy Power (<span class="formula-inline">P<sub>PE</sub></span>):</strong> This is the power required to lift the bike and rider against gravity when climbing (or gained from gravity when descending). It's calculated approximately as <span class="formula-inline">P<sub>PE</sub> ≈ V<sub>G</sub> * G<sub>R</sub> * m<sub>T</sub> * g</span>. Therefore, potential energy power increases <strong>linearly with ground speed (<span class="formula-inline">V<sub>G</sub></span>)</strong> and also <strong>linearly with the road gradient (<span class="formula-inline">G<sub>R</sub></span>)</strong>. This component can be positive (requiring power input on climbs) or negative (providing power on descents). Even small gradients significantly impact <span class="formula-inline">P<sub>PE</sub></span>.
                    </li>
                    <li>
                        <strong>Mechanical Losses (<span class="formula-inline">P<sub>WB</sub> + P<sub>C</sub></span>):</strong> These include power lost to friction in the wheel bearings (<span class="formula-inline">P<sub>WB</sub></span>, Wheel Bearing Power) and the drivetrain (<span class="formula-inline">P<sub>C</sub></span>, Chain Friction Power). Bearing friction power (<span class="formula-inline">P<sub>WB</sub></span>) increases roughly linearly with speed. Drivetrain losses (<span class="formula-inline">P<sub>C</sub></span>) are typically modeled as a small percentage (around 2-3%) of the power being transferred through the chain, meaning they also increase as the required net power goes up. These losses combined are generally a small fraction of the total power.
                    </li>
                </ul>
            </div>
            <div class="explanation-section" id="crr-explanation-section">
               <h3>Understanding Rolling Resistance (C<sub>rr</sub>) Values</h3>
               <p>
                   The Rolling Resistance Coefficient (<span class="formula-inline">C<sub>rr</sub></span>) value set by the slider represents a <strong>baseline</strong>, typically measured under standardized laboratory conditions (e.g., ~29 kph / 18 mph speed, ~42.5 kg load per tire, ~21-23°C temperature, on a smooth steel drum surface, as per tests on <a href="https://www.bicyclerollingresistance.com/the-test" target="_blank">bicyclerollingresistance.com</a>).
               </p>
               <p>
                   However, real-world <span class="formula-inline">C<sub>rr</sub></span> is influenced by several factors:
               </p>
               <ul>
                   <li><strong>Temperature:</strong> Lower temperatures generally <strong>increase</strong> rolling resistance. A drop from 23°C to 7°C can increase Crr by 5-10% or more for some tires.</li>
                   <li><strong>Load:</strong> While the total rolling resistance <em>force</em> increases with load (already included in the main formula <span class="formula-inline">P<sub>RR</sub> ≈ V<sub>G</sub> * C<sub>rr</sub> * m<sub>T</sub> * g</span>), the <span class="formula-inline">C<sub>rr</sub></span> coefficient itself tends to <strong>decrease slightly</strong> with higher loads per tire.</li>
                   <li><strong>Speed:</strong> Rolling resistance tends to <strong>increase slightly</strong> at higher speeds compared to the standard test speed.</li>
                   <li><strong>Road Surface:</strong> Real roads (asphalt, concrete) have higher rolling resistance than smooth lab drums. This can add a fixed amount to the power loss or effectively increase the <span class="formula-inline">C<sub>rr</sub></span>.</li>
                   <li><strong>Tire Pressure & Width:</strong> Lower pressure generally increases <span class="formula-inline">C<sub>rr</sub></span>. Wider tires *can* have lower <span class="formula-inline">C<sub>rr</sub></span> at the same pressure, but optimal pressure varies.</li>
               </ul>
               <p>
                   <strong>Using the Slider:</strong> The default value (<span class="formula-inline">0.0030</span>) is based on the <strong>Continental Grand Prix 5000 S TR (28mm, tubeless)</strong> under standard test conditions. You can adjust the slider based on these examples (values approximate from lab tests):
               </p>
               <ul>
                   <li><strong>Very Low / Racing (<span class="formula-inline">~0.0023 - 0.0028</span>):</strong> e.g., Vittoria Corsa Speed TLR G+ 2.0 (25mm), Michelin Power Time Trial (25mm).</li>
                   <li><strong>Low / Performance (<span class="formula-inline">~0.0028 - 0.0035</span>):</strong> e.g., Continental GP 5000 S TR (Standard), Schwalbe Pro One TLE Addix (28mm), Vittoria Corsa N.EXT TLR (28mm).</li>
                   <li><strong>Medium / All-Round (<span class="formula-inline">~0.0035 - 0.0045</span>):</strong> e.g., Continental Grand Prix 4 Season (28mm), Schwalbe Marathon Almotion V-Guard (40mm).</li>
                   <li><strong>High / Durable/Touring (<span class="formula-inline">~0.0045 - 0.0070+</span>):</strong> e.g., Continental Contact Urban (35mm), Schwalbe Marathon Plus (28mm).</li>
               </ul>
                <p>
                   Consider slightly <strong>increasing</strong> the <span class="formula-inline">C<sub>rr</sub></span> value from the lab baseline if riding in cold temperatures, on rougher surfaces, or significantly faster than the test speed. Consider slightly <strong>decreasing</strong> it if you are significantly heavier than the standard test load per tire.
               </p>
           </div>
           <div class="calculator-section">
                   <h3>Calculate Average Power for Manual Course</h3>
                   <form id="manualCourseForm">
                       <div class="input-group"> <label for="manualCourseLength">Course Length:</label> <input type="number" id="manualCourseLength" value="40" step="0.1" min="0.1"> <span class="unit">km</span> </div>
                       <div class="input-group"> <label for="manualCourseTime">Target Time:</label> <input type="text" id="manualCourseTime" value="01:00:00" pattern="\d{1,3}:\d{2}:\d{2}"> <span class="unit">h:mm:ss</span> </div>
                       <div class="input-group"> <label for="manualAvgCourseGradient">Avg. Gradient:</label> <input type="number" id="manualAvgCourseGradient" value="0.5" step="0.01" min="-20" max="20"> <span class="unit">%</span> </div>
                       <p class="input-group info"><i>Uses current sidebar values for Mass, C<sub>d</sub>A, C<sub>rr</sub>, ρ. Ignores Wind & Acceleration.</i></p>
                       <button type="button" id="calculateManualCourseBtn">Calculate Avg. Power</button>
                   </form>
                   <div class="calculator-output" id="manualCourseOutput" style="display: none;">
                       <p>Target Avg. Speed: <strong><span id="manualAvgSpeed">---</span> km/h</strong></p> <hr style="border-color: #ccc; margin: 8px 0;">
                       <p>Required Avg. Power: <strong><span id="manualAvgTotalPower">---</span> W</strong></p> <p>Avg. Power / kg Rider: <strong><span id="manualAvgPowerPerKg">---</span> W/kg</strong></p>
                   </div>
             </div>

             <div class="calculator-section">
                   <h3>Calculate Constant Power for Uploaded Profile</h3>
                    <form id="profileForm">
                       <div class="input-group"> <label for="profileFile">Upload Profile (CSV):</label> <input type="file" id="profileFile" accept=".csv, .txt"> <span class="info">CSV: segment_length_meters,gradient_percent (no header)</span> </div>
                       <div class="input-group"> <label for="targetTime">Target Total Time:</label> <input type="text" id="targetTime" value="01:00:00" pattern="\d{1,3}:\d{2}:\d{2}"> <span class="unit">h:mm:ss</span> </div>
                       <p class="input-group info"><i>Uses current sidebar values for Mass, C<sub>d</sub>A, C<sub>rr</sub>, ρ. Ignores Wind & Acceleration. Finds constant power for target time.</i></p>
                       <button type="button" id="calculateProfileBtn">Calculate Required Profile Power <span id="profileLoader" class="loader" style="display: none;"></span></button>
                   </form>
                   <div class="calculator-output" id="profileOutput" style="display: none;">
                       <p>Profile Distance: <strong><span id="profileDistance">---</span> km</strong></p> <p>Required Constant Power: <strong><span id="profilePower">---</span> W</strong></p> <p>Resulting Avg. Speed: <strong><span id="profileAvgSpeed">---</span> km/h</strong></p> <p>Power / kg Rider: <strong><span id="profilePowerPerKg">---</span> W/kg</strong></p> <p id="profileWarning" style="color: var(--accent-color); font-size: 0.85em; display: none;">Calculation might be approximate.</p>
                   </div>
             </div>

        </div>
    </div>

    <script>
        // --- Constants ---
        const g = 9.81; const Fw = 0.0044; const Ec = 0.97698; // Ec from Martin et al. 1998
        const solverIterations = 15; const bisectionIterations = 20;
        const defaultBarMaxY = 400; const plotSpeedMaxKmh = 50;
        const plotSpeedSteps = 51; const defaultLinePlotMinY = 0; const defaultLinePlotMaxY = 1200;

        // --- Global Variables ---
        let powerBarChart = null;
        let lineCharts = { current: null, minus5: null, zero: null, plus5: null };
        let profileData = null;

        // --- DOM Elements ---
        const velocityInput=document.getElementById('velocity'); const velocityValueSpan=document.getElementById('velocity-value'); const riderMassInput=document.getElementById('riderMass'); const riderMassValueSpan=document.getElementById('riderMass-value'); const bikeMassInput=document.getElementById('bikeMass'); const bikeMassValueSpan=document.getElementById('bikeMass-value'); const totalMassInputDisplay=document.getElementById('totalMass'); const totalMassValueSpan=document.getElementById('totalMass-value'); const gradientInput=document.getElementById('gradient'); const gradientValueSpan=document.getElementById('gradient-value'); const cdAInput=document.getElementById('cdA'); const cdAValueSpan=document.getElementById('cdA-value'); const crrInput=document.getElementById('crr'); const crrValueSpan=document.getElementById('crr-value'); const airDensityInput=document.getElementById('airDensity'); const airDensityValueSpan=document.getElementById('airDensity-value'); const windSpeedInput=document.getElementById('windSpeed'); const windSpeedValueSpan=document.getElementById('windSpeed-value'); const totalPowerSpan=document.getElementById('totalPower'); const powerPerKgSpan=document.getElementById('powerPerKg'); const powerAeroSpan=document.getElementById('powerAero'); const powerRollingSpan=document.getElementById('powerRolling'); const powerPotentialSpan=document.getElementById('powerPotential'); const powerMechanicalSpan=document.getElementById('powerMechanical'); const currentGradientLabelSpan=document.getElementById('currentGradientLabel'); const currentWindLabelSpan=document.getElementById('currentWindLabel'); const manualCourseLengthInput=document.getElementById('manualCourseLength'); const manualCourseTimeInput=document.getElementById('manualCourseTime'); const manualAvgCourseGradientInput=document.getElementById('manualAvgCourseGradient'); const calculateManualCourseBtn=document.getElementById('calculateManualCourseBtn'); const manualCourseOutputDiv=document.getElementById('manualCourseOutput'); const manualAvgSpeedSpan=document.getElementById('manualAvgSpeed'); const manualAvgTotalPowerSpan=document.getElementById('manualAvgTotalPower'); const manualAvgPowerPerKgSpan=document.getElementById('manualAvgPowerPerKg'); const profileFileInput=document.getElementById('profileFile'); const targetTimeInput=document.getElementById('targetTime'); const calculateProfileBtn=document.getElementById('calculateProfileBtn'); const profileOutputDiv=document.getElementById('profileOutput'); const profileDistanceSpan=document.getElementById('profileDistance'); const profilePowerSpan=document.getElementById('profilePower'); const profileAvgSpeedSpan=document.getElementById('profileAvgSpeed'); const profilePowerPerKgSpan=document.getElementById('profilePowerPerKg'); const profileWarning=document.getElementById('profileWarning'); const profileLoader=document.getElementById('profileLoader');

        // Color definitions with requested colors
        const COLORS = {
            aero: {
                bg: 'rgba(239, 83, 80, 0.1)', border: 'rgba(239, 83, 80, 1)', barBg: 'rgba(239, 83, 80, 0.7)'
            },
            roll: {
                bg: 'rgba(0, 150, 136, 0.1)', border: 'rgba(0, 150, 136, 1)', barBg: 'rgba(0, 150, 136, 0.7)'
            },
            potential: {
                bg: 'rgba(38, 131, 198, 0.1)', border: 'rgba(38, 131, 198, 1)', barBg: 'rgba(38, 131, 198, 0.7)'
            },
            mech: {
                bg: 'rgba(52, 58, 64, 0.1)', border: 'rgba(52, 58, 64, 1)', barBg: 'rgba(52, 58, 64, 0.7)'
            },
            total: {
                border: 'rgba(156, 133, 192, 1)'
            }
        };

        // --- Core Calculation (Unchanged logic, uses slider Crr directly) ---
        function calculatePowerComponents(Vg, m_T, Gr, CdA, Crr, rho, Vw) {
             if (Vg < 0.01) return { PAT: 0, PRR: 0, PPE: 0, PWB: 0, PKE: 0, PNET: 0, PTOT: 0, PC: 0, Pmech: 0 };
             const Va = Vg + Vw; // Note: Vw is negative for headwind in this implementation
             const F_D = 0.5 * rho * (CdA + Fw) * Math.pow(Va, 2) * Math.sign(Va);
             const PAT = F_D * Vg;
             const F_RR = Crr * m_T * g * Math.cos(Math.atan(Gr));
             const PRR = F_RR * Vg;
             const F_G = m_T * g * Math.sin(Math.atan(Gr));
             const PPE = F_G * Vg;
             const PWB = Vg * (91 + 8.7 * Vg) * 0.001; // Eq 7 from Martin et al.
             const PKE = 0; // Assume steady state for instantaneous calculation
             const PNET = PAT + PRR + PPE + PWB + PKE;
             const PTOT = Math.max(0, PNET / Ec);
             const PC = PTOT > 0 ? PTOT - PNET : 0; // Power lost in chain
             const Pmech = PWB + PC; // Total mechanical losses displayed
             return { PAT, PRR, PPE, PWB, PKE, PNET, PTOT, PC, Pmech };
        }

        // --- Live Update Display ---
        function updateInteractiveDisplay() {
             const V_kmh=parseFloat(velocityInput.value); const Vg=V_kmh/3.6; const riderMass=parseFloat(riderMassInput.value); const bikeMass=parseFloat(bikeMassInput.value); const m_T=riderMass+bikeMass; const Gr_percent=parseFloat(gradientInput.value); const Gr=Gr_percent/100; const CdA=parseFloat(cdAInput.value); const Crr=parseFloat(crrInput.value); const rho=parseFloat(airDensityInput.value); const Vw_kmh=parseFloat(windSpeedInput.value); const Vw=Vw_kmh/3.6;
             velocityValueSpan.textContent=`${V_kmh.toFixed(1)} km/h`; riderMassValueSpan.textContent=`${riderMass.toFixed(1)} kg`; bikeMassValueSpan.textContent=`${bikeMass.toFixed(1)} kg`; totalMassValueSpan.textContent=`${m_T.toFixed(1)} kg`; totalMassInputDisplay.value=`${m_T.toFixed(1)} kg`; gradientValueSpan.textContent=`${Gr_percent.toFixed(1)} %`; cdAValueSpan.textContent=`${CdA.toFixed(3)} m²`; crrValueSpan.textContent=`${Crr.toFixed(4)}`; airDensityValueSpan.textContent=`${rho.toFixed(3)} kg/m³`; windSpeedValueSpan.textContent=`${Vw_kmh.toFixed(1)} km/h`; currentGradientLabelSpan.textContent=Gr_percent.toFixed(1); currentWindLabelSpan.textContent=Vw_kmh.toFixed(1);
             const powers=calculatePowerComponents(Vg,m_T,Gr,CdA,Crr,rho,Vw);
             totalPowerSpan.textContent=powers.PTOT.toFixed(1); powerPerKgSpan.textContent=riderMass>0?(powers.PTOT/riderMass).toFixed(2):'---'; powerAeroSpan.textContent=powers.PAT.toFixed(1); powerRollingSpan.textContent=powers.PRR.toFixed(1); powerPotentialSpan.textContent=powers.PPE.toFixed(1); powerMechanicalSpan.textContent=powers.Pmech.toFixed(1);
             updateBarChart([powers.PAT,powers.PRR,powers.PPE,powers.Pmech]); updateAllLinePlots();
        }

        // --- Chart Update Functions ---
        function updateBarChart(powerData) {
             const ctx = document.getElementById('powerBarChart').getContext('2d');
             const labels = ['Aero Drag', 'Rolling Res.', 'Potential (Gravity)', 'Mechanical Loss'];
             const chartData = powerData.map(p => p);
             const backgroundColors = [ COLORS.aero.barBg, COLORS.roll.barBg, COLORS.potential.barBg, COLORS.mech.barBg ];
             const borderColors = [ COLORS.aero.border, COLORS.roll.border, COLORS.potential.border, COLORS.mech.border ];
             const maxValue = Math.max(...chartData.map(Math.abs)); let yMax = defaultBarMaxY;
             if(maxValue > defaultBarMaxY){yMax = Math.ceil((maxValue*1.1)/200)*200;}
             const minValue = Math.min(0,...chartData); let yMin = 0;
             if(minValue < -10){yMin = Math.floor(minValue/200)*200;}
             if (powerBarChart) {
                 powerBarChart.data.datasets[0].data = chartData;
                 powerBarChart.data.datasets[0].backgroundColor = backgroundColors;
                 powerBarChart.data.datasets[0].borderColor = borderColors;
                 powerBarChart.options.scales.y.max = yMax; powerBarChart.options.scales.y.min = yMin;
                 powerBarChart.update();
             } else {
                 powerBarChart = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Power (W)', data: chartData, backgroundColor: backgroundColors, borderColor: borderColors, borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'x', scales: { y: { beginAtZero: false, min: yMin, max: yMax, title: { display: true, text: 'Power (W)' }, ticks: { stepSize: 200 } }, x: { grid: { display: false } } }, plugins: { tooltip: { callbacks: { label: ctx => `${ctx.dataset.label || ''}: ${ctx.parsed.y.toFixed(1)} W` } }, legend: { display: false }, title: { display: false } }, animation: { duration: 200 } } });
            }
        }

        // --- Line Plot Functions ---
        function generatePlotData(targetGradient, windSpeed = 0) {
             const speeds_kmh=Array.from({length:plotSpeedSteps},(_,i)=>i*(plotSpeedMaxKmh/(plotSpeedSteps-1))); const plotData={aero:[],roll:[],potential:[],mech:[],total:[]}; const riderMass=parseFloat(riderMassInput.value); const bikeMass=parseFloat(bikeMassInput.value); const m_T=riderMass+bikeMass; const CdA=parseFloat(cdAInput.value); const Crr=parseFloat(crrInput.value); const rho=parseFloat(airDensityInput.value); const Gr=targetGradient/100; const Vw=windSpeed/3.6;
             speeds_kmh.forEach(v_kmh=>{const Vg=v_kmh/3.6; const powers=calculatePowerComponents(Vg,m_T,Gr,CdA,Crr,rho,Vw); plotData.aero.push(powers.PAT); plotData.roll.push(powers.PRR); plotData.potential.push(powers.PPE); plotData.mech.push(powers.Pmech); plotData.total.push(powers.PTOT);}); return{speeds_kmh,plotData};
        }

        function createOrUpdateLineChart(canvasId, chartInstance, gradient, windSpeed = 0) {
             const { speeds_kmh, plotData } = generatePlotData(gradient, windSpeed);
             const ctx = document.getElementById(canvasId).getContext('2d');
             const datasets = [ { label: 'Aero', data: plotData.aero, borderColor: COLORS.aero.border, backgroundColor: COLORS.aero.bg, fill: false, tension: 0.1, borderWidth: 2, pointRadius: 0 }, { label: 'Roll', data: plotData.roll, borderColor: COLORS.roll.border, backgroundColor: COLORS.roll.bg, fill: false, tension: 0.1, borderWidth: 2, pointRadius: 0 }, { label: 'Potential', data: plotData.potential, borderColor: COLORS.potential.border, backgroundColor: COLORS.potential.bg, fill: false, tension: 0.1, borderWidth: 2, pointRadius: 0 }, { label: 'Mech Loss', data: plotData.mech, borderColor: COLORS.mech.border, backgroundColor: COLORS.mech.bg, fill: false, tension: 0.1, borderWidth: 2, pointRadius: 0 }, { label: 'Total', data: plotData.total, borderColor: COLORS.total.border, backgroundColor: COLORS.total.border, fill: false, tension: 0.1, borderWidth: 3, borderDash: [5, 5], pointRadius: 0 } ];
             let minVal = Infinity, maxVal = -Infinity; datasets.forEach(ds => { ds.data.forEach(val => { if(!isNaN(val)){ if(val < minVal) minVal = val; if(val > maxVal) maxVal = val; } }); }); if(minVal === Infinity) minVal = 0; if(maxVal === -Infinity) maxVal = defaultLinePlotMaxY;
             let yMin = defaultLinePlotMinY; let yMax = defaultLinePlotMaxY; if (minVal < defaultLinePlotMinY) { yMin = Math.floor((minVal * 1.05) / 200) * 200; } if (maxVal > defaultLinePlotMaxY) { yMax = Math.ceil((maxVal * 1.05) / 200) * 200; } if (yMin > 0) yMin = 0; if (yMax < 0 && minVal < 0) yMax = 0; if (maxVal <= defaultLinePlotMaxY && yMax < defaultLinePlotMaxY) yMax = defaultLinePlotMaxY; if (minVal >= defaultLinePlotMinY && yMin > defaultLinePlotMinY) yMin = defaultLinePlotMinY; if (yMin >= yMax) { yMin = Math.min(0, yMax - 200); }
             const options = { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Speed (km/h)' } }, y: { title: { display: true, text: 'Power (W)' }, min: yMin, max: yMax, ticks: { stepSize: 200 } } }, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: {size: 10 } } }, tooltip: { mode: 'index', intersect: false, callbacks: { label: ctx => `${ctx.dataset.label || ''}: ${ctx.parsed.y.toFixed(1)} W` } } }, animation: { duration: 0 } };
             if (chartInstance) { chartInstance.data.labels = speeds_kmh; chartInstance.data.datasets = datasets; chartInstance.options.scales.y.min = yMin; chartInstance.options.scales.y.max = yMax; chartInstance.update(); return chartInstance; } else { return new Chart(ctx, { type: 'line', data: { labels: speeds_kmh, datasets: datasets }, options: options }); }
        }

        function updateAllLinePlots() {
             const currentGradient = parseFloat(gradientInput.value); const currentWindSpeed = parseFloat(windSpeedInput.value);
             lineCharts.current = createOrUpdateLineChart('plotCurrentGradient', lineCharts.current, currentGradient, currentWindSpeed);
             lineCharts.minus5 = createOrUpdateLineChart('plotGradientMinus5', lineCharts.minus5, -5);
             lineCharts.zero = createOrUpdateLineChart('plotGradientZero', lineCharts.zero, 0);
             lineCharts.plus5 = createOrUpdateLineChart('plotGradientPlus5', lineCharts.plus5, 5);
        }

        // --- Utility Functions ---
        function parseTimeToSeconds(timeStr) { const parts=timeStr.split(':'); if(parts.length!==3)return NaN; const h=parseInt(parts[0],10); const m=parseInt(parts[1],10); const s=parseInt(parts[2],10); if(isNaN(h)||isNaN(m)||isNaN(s)||h<0||m<0||s<0||m>=60||s>=60)return NaN; return h*3600+m*60+s; }

        // --- Manual Course Calculation ---
        function calculateManualCoursePower() { const length_km=parseFloat(manualCourseLengthInput.value); const timeStr=manualCourseTimeInput.value; const avgGradientPercent=parseFloat(manualAvgCourseGradientInput.value); const riderMass=parseFloat(riderMassInput.value); const bikeMass=parseFloat(bikeMassInput.value); const m_T=riderMass+bikeMass; const CdA=parseFloat(cdAInput.value); const Crr=parseFloat(crrInput.value); const rho=parseFloat(airDensityInput.value); const time_s=parseTimeToSeconds(timeStr); if(isNaN(time_s)||time_s<=0||isNaN(length_km)||length_km<=0||isNaN(avgGradientPercent)||m_T<=0){alert("Please enter valid values for manual course length, time, gradient, and masses."); manualCourseOutputDiv.style.display='none'; return;} const length_m=length_km*1000; const Gr_avg=avgGradientPercent/100; const Vg_avg=length_m/time_s; const Vg_avg_kmh=Vg_avg*3.6; const avgPowers=calculatePowerComponents(Vg_avg,m_T,Gr_avg,CdA,Crr,rho,0); manualAvgSpeedSpan.textContent=Vg_avg_kmh.toFixed(1); manualAvgTotalPowerSpan.textContent=avgPowers.PTOT.toFixed(1); manualAvgPowerPerKgSpan.textContent=riderMass>0?(avgPowers.PTOT/riderMass).toFixed(2):'---'; manualCourseOutputDiv.style.display='block'; }

        // --- Profile Upload & Calculation Functions ---
        function solveSpeedForPower(power_tot, m_T, Gr, CdA, Crr, rho) { const target_pnet=power_tot*Ec; let Vg=5.0; let calculated_pnet; if(target_pnet<=0){let Vg_downhill=5.0; for(let i=0; i<solverIterations*2; i++){const powers=calculatePowerComponents(Vg_downhill,m_T,Gr,CdA,Crr,rho,0); calculated_pnet=powers.PNET; const error=target_pnet-calculated_pnet; if(Math.abs(error)<0.5)break; Vg_downhill+=error*0.005; Vg_downhill=Math.max(0.1,Math.min(Vg_downhill,100/3.6));}return Vg_downhill;} for(let i=0; i<solverIterations; i++){const powers=calculatePowerComponents(Vg,m_T,Gr,CdA,Crr,rho,0); calculated_pnet=powers.PNET; const error=target_pnet-calculated_pnet; let adjustmentFactor=0.01; if(Math.abs(calculated_pnet)>10){adjustmentFactor=Vg/(3*calculated_pnet);} Vg+=error*adjustmentFactor; Vg=Math.max(0.1,Math.min(Vg,100/3.6)); if(Math.abs(error)<0.1)break;} const finalPowers=calculatePowerComponents(Vg,m_T,Gr,CdA,Crr,rho,0); if(Math.abs(target_pnet-finalPowers.PNET)>5 && target_pnet>0){console.warn(`Vg solver might not have converged well. Target PNET: ${target_pnet.toFixed(1)}, Calc PNET: ${finalPowers.PNET.toFixed(1)} at Vg: ${Vg.toFixed(2)}`); profileWarning.style.display='block';}else{profileWarning.style.display='none';} return Vg; }
        function calculateTimeForProfile(power_tot, profile, params) { let total_time=0; if(!profile||profile.length===0)return Infinity; profile.forEach(segment=>{const L_i=segment.length; const Gr_i=segment.gradient; const Vg_i=solveSpeedForPower(power_tot,params.m_T,Gr_i,params.CdA,params.Crr,params.rho); if(Vg_i>0.01&&isFinite(Vg_i)){total_time+=L_i/Vg_i;}else{total_time=Infinity;return;}}); return total_time; }
        function solvePowerForTime(target_time, profile, params) { if(!profile||profile.length===0||target_time<=0)return{power:NaN,time:NaN}; let low_power=0; let high_power=1500; let mid_power=150; let calculated_time=Infinity; const time_at_0W=calculateTimeForProfile(0,profile,params); if(target_time>=time_at_0W)return{power:0,time:time_at_0W}; const time_at_highW=calculateTimeForProfile(high_power,profile,params); if(target_time<time_at_highW){console.warn(`Target time ${target_time}s might be unachievable even at ${high_power}W (min time: ${time_at_highW.toFixed(0)}s)`); return{power:high_power,time:time_at_highW};} for(let i=0; i<bisectionIterations; i++){mid_power=(low_power+high_power)/2; calculated_time=calculateTimeForProfile(mid_power,profile,params); if(!isFinite(calculated_time)){console.warn("Time calculation resulted in Infinity, adjusting power up."); low_power=mid_power; continue;} if(Math.abs(calculated_time-target_time)<1)break; if(calculated_time>target_time){low_power=mid_power;}else{high_power=mid_power;}} return{power:mid_power,time:calculated_time}; }
        function handleProfileUpload(event) { const file=event.target.files[0]; if(!file)return; const reader=new FileReader(); reader.onload=(e)=>{const text=e.target.result; try{const lines=text.trim().split(/[\r\n]+/); profileData=lines.map(line=>{const parts=line.split(/[,;\t]/); if(parts.length>=2){const length=parseFloat(parts[0]); const gradient=parseFloat(parts[1]); if(!isNaN(length)&&!isNaN(gradient)&&length>0)return{length:length,gradient:gradient/100};} return null;}).filter(Boolean); if(profileData.length===0){alert("Could not parse profile data or file is empty. Ensure CSV format: length_meters,gradient_percent"); profileData=null; profileFileInput.value='';}else{console.log(`Parsed ${profileData.length} profile segments.`);}}catch(error){alert("Error parsing file: "+error.message); profileData=null; profileFileInput.value='';}}; reader.onerror=()=>{alert("Error reading file."); profileData=null; profileFileInput.value='';}; reader.readAsText(file); }
        function triggerProfileCalculation() { if(!profileData||profileData.length===0){alert("Please upload a valid profile CSV file first."); return;} const target_time_str=targetTimeInput.value; const target_time_s=parseTimeToSeconds(target_time_str); if(isNaN(target_time_s)||target_time_s<=0){alert("Please enter a valid target time in h:mm:ss format."); return;} calculateProfileBtn.disabled=true; profileLoader.style.display='inline-block'; profileOutputDiv.style.display='none'; const riderMass=parseFloat(riderMassInput.value); const bikeMass=parseFloat(bikeMassInput.value); const m_T=riderMass+bikeMass; const CdA=parseFloat(cdAInput.value); const Crr=parseFloat(crrInput.value); const rho=parseFloat(airDensityInput.value); const params={m_T,CdA,Crr,rho}; setTimeout(()=>{try{const result=solvePowerForTime(target_time_s,profileData,params); const totalDistance_m=profileData.reduce((sum,seg)=>sum+seg.length,0); const totalDistance_km=totalDistance_m/1000; const avgSpeed_mps=result.time>0&&isFinite(result.time)?totalDistance_m/result.time:0; const avgSpeed_kmh=avgSpeed_mps*3.6; profileDistanceSpan.textContent=totalDistance_km.toFixed(2); profilePowerSpan.textContent=result.power.toFixed(1); profileAvgSpeedSpan.textContent=avgSpeed_kmh.toFixed(1); profilePowerPerKgSpan.textContent=riderMass>0?(result.power/riderMass).toFixed(2):'---'; profileOutputDiv.style.display='block';}catch(error){console.error("Error during profile power calculation:",error); alert("An error occurred during calculation."); profileOutputDiv.style.display='none';}finally{calculateProfileBtn.disabled=false; profileLoader.style.display='none';}},10); }

        // --- Event Listeners ---
        const sliders=document.querySelectorAll('.sidebar input[type="range"]'); sliders.forEach(slider=>slider.addEventListener('input',updateInteractiveDisplay));
        riderMassInput.addEventListener('input',()=>{const totalMass=(parseFloat(riderMassInput.value||0)+parseFloat(bikeMassInput.value||0)); totalMassValueSpan.textContent=`${totalMass.toFixed(1)} kg`; totalMassInputDisplay.value=`${totalMass.toFixed(1)} kg`; updateInteractiveDisplay();}); // Trigger update on mass change
        bikeMassInput.addEventListener('input',()=>{const totalMass=(parseFloat(riderMassInput.value||0)+parseFloat(bikeMassInput.value||0)); totalMassValueSpan.textContent=`${totalMass.toFixed(1)} kg`; totalMassInputDisplay.value=`${totalMass.toFixed(1)} kg`; updateInteractiveDisplay();}); // Trigger update on mass change
        calculateManualCourseBtn.addEventListener('click',calculateManualCoursePower);
        profileFileInput.addEventListener('change',handleProfileUpload);
        calculateProfileBtn.addEventListener('click',triggerProfileCalculation);

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded',()=>{updateInteractiveDisplay(); updateAllLinePlots();});

    </script>
</body>
</html>