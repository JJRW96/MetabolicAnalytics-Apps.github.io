<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Etalon W/kg Performance Converter</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2683C6;
            --secondary-color: #9C85C0;
            --accent-color: #EF5350;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-color: #dee2e6;
            --gradient-start: #f1f8ff;
            --gradient-end: #ffffff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        body { background-color: #f5f5f5; color: var(--dark-color); line-height: 1.6; overflow-x: hidden; }

        .container { display: flex; min-height: 100vh; max-width: 100%; }

        .sidebar {
            width: 340px; flex-shrink: 0; background: linear-gradient(to bottom, var(--gradient-start), var(--gradient-end));
            padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); overflow-y: auto;
            border-right: 1px solid var(--border-color); max-height: 100vh; position: relative; z-index: 10;
        }

        .main-content {
            flex: 1; padding: 20px; display: flex; flex-direction: column; background-color: #fff; overflow-x: auto;
        }
        
        h1, h2 { color: var(--primary-color); text-align: center; }
        h1 { margin-bottom: 10px; font-size: 1.5rem; padding-bottom: 10px; border-bottom: 2px solid var(--border-color); }
        h2 { margin-bottom: 20px; font-size: 1.3rem; }
        .sidebar h2 { font-size: 1.3rem; border-bottom: none; text-align: left; }
        
        /* --- Mode Switcher --- */
        .mode-switcher {
            display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 15px;
            background-color: #e9ecef; border-radius: 6px; padding: 4px;
        }
        .mode-button {
            padding: 8px 5px; cursor: pointer; border: none; background-color: transparent;
            font-weight: 500; text-align: center; transition: all 0.3s;
            border-radius: 4px; font-size: 0.85rem; color: #555;
        }
        .mode-button:hover { background-color: #dcdcdc; }
        .mode-button.active { background-color: #fff; color: var(--primary-color); font-weight: 700; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .mode-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        /* --- End Mode Switcher --- */

        .control-group { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); background-color: white; border-radius: 6px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .control-group:last-child { border-bottom: none; }

        .control-label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--dark-color); font-size: 0.95rem; }
        
        .profile-selector { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); margin-bottom: 10px; font-size: 0.95rem; }

        .slider-container { margin-bottom: 15px; }
        .slider-label { display: flex; justify-content: space-between; align-items: center; width: 100%; font-size: 0.9rem; }
        .slider-label label { flex-grow: 1; }
        .slider-value { min-width: 70px; text-align: right; font-weight: bold; color: var(--primary-color); }
        .range-slider { -webkit-appearance: none; width: 100%; height: 8px; border-radius: 5px; background: linear-gradient(to right, #ddd, var(--primary-color)); outline: none; margin: 10px 0; }
        .range-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--primary-color); cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        
        button { background-color: var(--primary-color); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: 600; transition: all 0.3s; margin-top: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); width: 100%; }
        button:hover { background-color: #1a6eae; transform: translateY(-1px); box-shadow: 0 3px 5px rgba(0,0,0,0.15); }
        
        .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .info-icon { color: var(--primary-color); cursor: pointer; font-size: 1.1rem; width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; background-color: rgba(38, 131, 198, 0.1); vertical-align: middle; margin-left: 5px; }
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext {
            visibility: hidden; width: 320px; background-color: #555; color: #fff; text-align: left; border-radius: 6px; padding: 10px;
            position: absolute; z-index: 1000; opacity: 0; transition: opacity 0.3s; font-size: 0.9rem; line-height: 1.4;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); pointer-events: none;
            /* Position tooltip relative to icon */
            bottom: 125%; left: 50%; margin-left: -160px; 
        }
        .tooltip .tooltiptext::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #555 transparent transparent transparent; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        
        .sidebar-tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .tab-button { flex-grow: 1; padding: 10px 15px; cursor: pointer; border: none; background-color: transparent; color: var(--dark-color); font-weight: 500; text-align: center; transition: background-color 0.3s, color 0.3s; border-bottom: 3px solid transparent; margin-top: 0; box-shadow: none; font-size: 0.9rem; }
        .tab-button:hover { background-color: rgba(38, 131, 198, 0.1); color: var(--primary-color); transform: none; box-shadow: none; }
        .tab-button.active { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); font-weight: 700; }
        .tab-content { display: none; animation: fadeInTab 0.5s; }
        @keyframes fadeInTab { from { opacity: 0; } to { opacity: 1; } }

        .data-point-display { background-color: var(--light-color); padding: 8px; border-radius: 4px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; }
        .remove-point-btn { background-color: var(--accent-color); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em; width: auto; margin-top: 0; }
        .new-data-point-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; margin-bottom: 10px; }
        .new-data-point-inputs input { width: 100%; padding: 6px 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.9em; }
        .full-width-input { grid-column: 1 / -1; }

        #results-table-container { margin-top: 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 6px; overflow: hidden; }
        th, td { padding: 8px 10px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        td:first-child { white-space: normal; min-width: 150px; }
        th { background-color: var(--primary-color); color: white; font-weight: 600; position: sticky; top: 0; z-index: 5; cursor: pointer; user-select: none; }
        th:hover { background-color: #1a6eae; }
        th .sort-icon { margin-left: 5px; opacity: 0.7; font-size: 0.8em; display: inline-block; width: 10px;}
        tr:nth-child(even) { background-color: var(--light-color); }
        tr:hover { background-color: #e9ecef; }
        .diff-positive { color: #28a745; }
        .diff-negative { color: var(--accent-color); }
        
        .disclaimer { margin-top: 15px; padding: 10px; background-color: var(--light-color); border-left: 3px solid var(--secondary-color); font-size: 0.85rem; color: #555; border-radius: 4px; }
        .disclaimer strong { color: var(--dark-color); }
        .profile-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .file-name-display { font-size: 0.8rem; color: #555; margin-top: 5px; text-align: center; word-break: break-all; }
        .explanation-box { margin-top: 20px; padding: 15px; background-color: #f1f8ff; border-left: 4px solid var(--primary-color); border-radius: 4px; font-size: 0.9rem; line-height: 1.5; }
        .explanation-box h3 { color: var(--primary-color); margin-top: 0; margin-bottom: 10px; font-size: 1.1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .explanation-box ul { padding-left: 20px; margin-top: 10px; margin-bottom: 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h1>Etalon Converter</h1>

            <div class="control-group">
                <div class="mode-header">
                    <label class="control-label" style="margin-bottom:0;">Calculation Mode</label>
                    <div class="tooltip info-icon">ⓘ
                        <span class="tooltiptext">
                            <b>Etalon → Real Power:</b> (Standard Mode) Calculates the real-world power of your selected rider, based on a standardized 'Etalon W/kg' performance benchmark and an actual time. Ideal for analyzing race performances.
                            <br><br>
                            <b>Real Power → Etalon:</b> (Reverse Mode) Calculates the 'Etalon W/kg' benchmark from your rider's real-world power output. Ideal for standardizing and comparing your own power data against benchmarks.
                        </span>
                    </div>
                </div>
                <div class="mode-switcher">
                    <button id="mode-etalon-to-real" class="mode-button active">Etalon → Real Power</button>
                    <button id="mode-real-to-etalon" class="mode-button">Real Power → Etalon</button>
                </div>
            </div>

            <div class="sidebar-tabs">
                <button class="tab-button active" onclick="openTab(event, 'tabParameters')">Model Parameters</button>
                <button class="tab-button" onclick="openTab(event, 'tabPerformances')">Performance Data</button>
            </div>

            <div id="tabParameters" class="tab-content" style="display: block;">
                 <div class="control-group">
                     <label for="profile-selector" class="control-label">Load Example Profile:</label>
                     <select id="profile-selector" class="profile-selector">
                         <option value="">-- Select Profile --</option>
                         <option value="pogi">Pogi's 2024 Performances</option>
                     </select>
                </div>
                 <div class="control-group">
                    <div class="header-section"><h2>Rider & Equipment</h2></div>
                    <div class="slider-container">
                        <div class="slider-label"><label for="rider_mass">Rider Mass:</label><span id="rider_mass-value" class="slider-value">60.0 kg</span></div>
                        <input type="range" id="rider_mass" class="range-slider" min="40" max="120" value="60.0" step="0.1">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label"><label for="bike_mass">Bike & Gear Mass:</label><span id="bike_mass-value" class="slider-value">7.2 kg</span></div>
                        <input type="range" id="bike_mass" class="range-slider" min="5.0" max="12" value="7.2" step="0.1">
                    </div>
                </div>
                <div class="control-group">
                    <div class="header-section"><h2>Environmental & Mechanical Factors</h2></div>
                    <div class="slider-container">
                        <div class="slider-label"><label for="crr">Rolling Resistance (Crr):</label><div class="tooltip info-icon">ⓘ<span class="tooltiptext">Coefficient of Rolling Resistance. Typical values: 0.0025 (fast track), 0.0035 (good road tire), 0.0050 (average road).</span></div><span id="crr-value" class="slider-value">0.0035</span></div>
                        <input type="range" id="crr" class="range-slider" min="0.0020" max="0.0060" value="0.0035" step="0.0001">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label"><label for="cda">Aerodynamic Drag (CdA):</label><div class="tooltip info-icon">ⓘ<span class="tooltiptext">Drag Area (m²). Typical values: 0.28 (elite TT position), 0.32 (good road position), 0.40 (upright).</span></div><span id="cda-value" class="slider-value">0.30 m²</span></div>
                        <input type="range" id="cda" class="range-slider" min="0.25" max="0.45" value="0.35" step="0.01">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label"><label for="rho">Air Density (ρ):</label><div class="tooltip info-icon">ⓘ<span class="tooltiptext">Air Density (kg/m³). Sea level: ~1.225. 1500m altitude: ~1.058.</span></div><span id="rho-value" class="slider-value">1.10 kg/m³</span></div>
                        <input type="range" id="rho" class="range-slider" min="0.95" max="1.25" value="1.10" step="0.01">
                    </div>
                     <div class="slider-container">
                        <div class="slider-label"><label for="drivetrain_loss">Drivetrain Loss:</label><div class="tooltip info-icon">ⓘ<span class="tooltiptext">Power loss in chain and bearings. 2.0% for a very clean, high-end drivetrain. 3.5% is more typical.</span></div><span id="drivetrain_loss-value" class="slider-value">2.5 %</span></div>
                        <input type="range" id="drivetrain_loss" class="range-slider" min="1.5" max="5.0" value="2.5" step="0.1">
                    </div>
                </div>
            </div>

            <div id="tabPerformances" class="tab-content">
                <div class="control-group">
                    <div class="header-section"><h2 id="add-perf-title">Add & Compare Performance</h2></div>
                    <div id="performance-data-container"></div>
                    <div class="new-data-point-inputs">
                        <input type="text" id="new-point-label" placeholder="Label (e.g., Alpe d'Huez)" class="full-width-input">
                        <input type="number" id="new-point-length" placeholder="Length (km)" step="0.01">
                        <input type="number" id="new-point-elevation" placeholder="Elevation (m)" step="1">
                        
                        <!-- Mode 1: Etalon -> Real (Original Layout) -->
                        <div id="etalon-to-real-inputs" class="full-width-input">
                            <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                                <input type="number" id="new-point-etalon-wkg" placeholder="Etalon W/kg (Benchmark)" step="0.01">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <input type="number" id="new-point-duration-min" placeholder="Actual Time (min)" min="0">
                                    <input type="number" id="new-point-duration-sec" placeholder="Actual Time (s)" min="0" max="59">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mode 2: Real -> Etalon -->
                         <div id="real-to-etalon-inputs" class="full-width-input" style="display: none;">
                            <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                                <input type="number" id="new-point-power" placeholder="Actual Power (W)" step="1">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                     <input type="number" id="new-point-power-duration-min" placeholder="Duration (min)" min="0">
                                     <input type="number" id="new-point-power-duration-sec" placeholder="Duration (s)" min="0" max="59">
                                </div>
                            </div>
                        </div>

                    </div>
                    <button id="add-performance-btn">Add & Compare Performance</button>
                </div>
                 <div id="explanation-box-wind" class="explanation-box">
                    <h3>Effective Wind Factor Explained</h3>
                    <p>This tool analyzes the difference between the <strong>actual time</strong> and the time that would be <strong>expected</strong> based on the Etalon W/kg in ideal (windless) conditions. The discrepancy is quantified as an "Effective Wind".</p>
                    <ul>
                        <li><strong>Eff. Wind (m/s):</strong> This is the constant headwind (positive value) or tailwind (negative value) in meters per second that would be required in the model to make the predicted time match the actual time.</li>
                        <li><strong>Real Power (W):</strong> This is the recalculated power the rider, with their specific weight from the sliders, had to produce to achieve the actual time, factoring in the calculated effective wind.</li>
                    </ul>
                </div>
                <div class="control-group">
                    <div class="header-section"><h2>Profile Management</h2></div>
                    <div class="profile-buttons">
                        <button id="save-profile-btn">Save Profile</button>
                        <button id="load-profile-trigger-btn" style="background-color: var(--secondary-color);">Load Profile</button>
                    </div>
                    <input type="file" id="load-profile-input" accept=".json" style="display: none;">
                    <div id="loaded-file-name" class="file-name-display"></div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <h2 id="main-content-title">Performance Conversion Results</h2>
            <div id="results-table-container"></div>
            <div class="disclaimer">
                <strong>Model Disclaimer:</strong> The calculations in this model are based on a simplified physics engine. They assume constant conditions and do not account for variable wind, gusts, or the aerodynamic benefit of drafting. Therefore, these results may differ from on-bike power meter data.
            </div>
             <div class="explanation-box">
                <h3>Understanding "Etalon W/kg"</h3>
                <p><strong>'Etalon'</strong> (French for 'standard' or 'benchmark') creates a true "apples-to-apples" comparison by neutralizing the inherent advantages of rider weight. All performances are recalculated to a standardized <strong>60 kg rider</strong> with a <strong>7.2 kg bike</strong>.</p>
                <p>The `W/kg Etalon` value is not a rider's actual power output, but a standardized metric designed for objective performance evaluation across different athletes and conditions.</p>
            </div>
        </div>
    </div>

<script>
// --- GLOBAL STATE & CONSTANTS ---
const POGI_PERFORMANCES = [
    { label: "La Turbie", lengthKm: 8.05, elevationM: 469, etalonWkg: 7.05, durationS: 1018 },
    { label: "La Couillole", lengthKm: 15.61, elevationM: 1175, etalonWkg: 6.52, durationS: 2357 },
    { label: "Plateau de Beille", lengthKm: 15.74, elevationM: 1250, etalonWkg: 6.98, durationS: 2390 },
    { label: "Pla d'Adet", lengthKm: 10.58, elevationM: 845, etalonWkg: 6.85, durationS: 1670 },
    { label: "Isola 2000", lengthKm: 15.70, elevationM: 1136, etalonWkg: 6.83, durationS: 2264 },
    { label: "Puy Mary", lengthKm: 2.08, elevationM: 270, etalonWkg: 7.50, durationS: 443 },
    { label: "Collada de Sant Isidre", lengthKm: 5.00, elevationM: 439, etalonWkg: 7.02, durationS: 824 },
    { label: "San Luca", lengthKm: 2.10, elevationM: 197, etalonWkg: 7.89, durationS: 327 },
    { label: "Monte Grappa", lengthKm: 18.10, elevationM: 1482, etalonWkg: 6.19, durationS: 3102 }
];

const PROFILES = {
    pogi: {
        riderMass: 64.5, bikeMass: 7.2, Crr: 0.0035, CdA: 0.30, rho: 1.10, drivetrainLoss: 2.5,
        performances: POGI_PERFORMANCES
    }
};

const createInitialState = () => ({
    mode: 'etalonToReal', // 'etalonToReal' or 'realToEtalon'
    riderMass: 60.0, etalonMass: 60.0, etalonBikeMass: 7.2,
    bikeMass: 7.2, Crr: 0.0035, CdA: 0.30, rho: 1.10, drivetrainLoss: 2.5,
    performances: [],
    sortColumn: 'etalonWkg', sortDirection: 'desc'
});

let appState = createInitialState();

const dom = {
    // Mode Switcher
    modeEtalonToRealBtn: document.getElementById('mode-etalon-to-real'),
    modeRealToEtalonBtn: document.getElementById('mode-real-to-etalon'),
    mainContentTitle: document.getElementById('main-content-title'),
    // Sidebar
    riderMassSlider: document.getElementById('rider_mass'), riderMassValue: document.getElementById('rider_mass-value'),
    bikeMassSlider: document.getElementById('bike_mass'), bikeMassValue: document.getElementById('bike_mass-value'),
    crrSlider: document.getElementById('crr'), crrValue: document.getElementById('crr-value'),
    cdaSlider: document.getElementById('cda'), cdaValue: document.getElementById('cda-value'),
    rhoSlider: document.getElementById('rho'), rhoValue: document.getElementById('rho-value'),
    drivetrainLossSlider: document.getElementById('drivetrain_loss'), drivetrainLossValue: document.getElementById('drivetrain_loss-value'),
    // Performance Tab
    performanceDataContainer: document.getElementById('performance-data-container'),
    addPerfTitle: document.getElementById('add-perf-title'),
    addPerformanceBtn: document.getElementById('add-performance-btn'),
    newPointLabelInput: document.getElementById('new-point-label'),
    newPointLengthInput: document.getElementById('new-point-length'),
    newPointElevationInput: document.getElementById('new-point-elevation'),
    // Mode-specific input containers
    etalonToRealInputs: document.getElementById('etalon-to-real-inputs'),
    realToEtalonInputs: document.getElementById('real-to-etalon-inputs'),
    // Mode 1 inputs
    newPointEtalonWkgInput: document.getElementById('new-point-etalon-wkg'),
    newPointDurationMinInput: document.getElementById('new-point-duration-min'),
    newPointDurationSecInput: document.getElementById('new-point-duration-sec'),
    // Mode 2 inputs
    newPointPowerInput: document.getElementById('new-point-power'),
    newPointPowerDurationMinInput: document.getElementById('new-point-power-duration-min'),
    newPointPowerDurationSecInput: document.getElementById('new-point-power-duration-sec'),
    explanationBoxWind: document.getElementById('explanation-box-wind'),
    // Profile Management
    profileSelector: document.getElementById('profile-selector'),
    saveProfileBtn: document.getElementById('save-profile-btn'),
    loadProfileTriggerBtn: document.getElementById('load-profile-trigger-btn'),
    loadProfileInput: document.getElementById('load-profile-input'),
    loadedFileName: document.getElementById('loaded-file-name'),
    // Main Content
    resultsTableContainer: document.getElementById('results-table-container'),
};

// --- CORE CALCULATION ENGINE ---
function calculatePerformance(performance) {
    const { riderMass, bikeMass, Crr, CdA, rho, drivetrainLoss, etalonMass, etalonBikeMass } = appState;
    const g = 9.81;
    const lengthM = performance.lengthKm * 1000;
    
    const baseReturn = { ...performance };
    if (lengthM <= 0) return baseReturn;
    
    const gradient = performance.elevationM / lengthM;
    baseReturn.gradient = gradient;

    const solvePowerAtWheel = (v_g, M_sys, v_wind = 0) => {
        const v_air = v_g + v_wind;
        const P_gravity = M_sys * g * Math.sin(Math.atan(gradient)) * v_g;
        const P_rolling = Crr * M_sys * g * Math.cos(Math.atan(gradient)) * v_g;
        const P_aero = 0.5 * rho * CdA * v_air * v_air * v_g;
        return P_gravity + P_rolling + P_aero;
    };

    if (appState.mode === 'etalonToReal') {
        const { etalonWkg, durationS } = performance;
        if (durationS <= 0) return baseReturn;
        const actual_speed_ms = lengthM / durationS;
        
        const etalonAbsolutePower = etalonWkg * etalonMass;
        const etalonPowerAtWheel_ideal = etalonAbsolutePower * (1 - drivetrainLoss / 100);

        let v_expected = 5;
        for (let i = 0; i < 20; i++) {
            let p_guess = solvePowerAtWheel(v_expected, etalonMass + etalonBikeMass, 0);
            if (p_guess > 1e-6) v_expected *= Math.pow(etalonPowerAtWheel_ideal / p_guess, 0.333);
        }
        const durationS_expected = lengthM / v_expected;

        const P_gravity_etalon_actual = (etalonMass + etalonBikeMass) * g * Math.sin(Math.atan(gradient)) * actual_speed_ms;
        const P_rolling_etalon_actual = Crr * (etalonMass + etalonBikeMass) * g * Math.cos(Math.atan(gradient)) * actual_speed_ms;
        const P_aero_required = etalonPowerAtWheel_ideal - P_gravity_etalon_actual - P_rolling_etalon_actual;
        
        let v_wind = 0;
        const aero_const = 0.5 * rho * CdA * actual_speed_ms;
        if (aero_const > 1e-9) {
            const v_air_sq = P_aero_required / aero_const;
            v_wind = (v_air_sq >= 0 ? Math.sqrt(v_air_sq) : -Math.sqrt(-v_air_sq)) - actual_speed_ms;
        }

        const P_wheel_real_with_wind = solvePowerAtWheel(actual_speed_ms, riderMass + bikeMass, v_wind);
        const realAbsolutePower = P_wheel_real_with_wind / (1 - drivetrainLoss / 100);
        
        return {
            ...baseReturn,
            speedKmh: actual_speed_ms * 3.6, VAM: (performance.elevationM / durationS) * 3600,
            durationS_expected, timeDifferenceS: durationS - durationS_expected, effectiveWindMs: v_wind,
            realAbsolutePower, realWkg: riderMass > 0 ? realAbsolutePower / riderMass : 0
        };
    } 
    else if (appState.mode === 'realToEtalon') {
        const { absolutePower, durationS } = performance;
        if (durationS <= 0) return baseReturn;
        const speed_ms = lengthM / durationS;
        
        const etalonPowerAtWheel = solvePowerAtWheel(speed_ms, etalonMass + etalonBikeMass, 0);
        const etalonAbsolutePower = etalonPowerAtWheel / (1 - drivetrainLoss / 100);
        
        return {
            ...baseReturn,
            speedKmh: speed_ms * 3.6, VAM: (performance.elevationM / durationS) * 3600,
            realWkg: riderMass > 0 ? absolutePower / riderMass : 0,
            etalonAbsolutePower, etalonWkg: etalonMass > 0 ? etalonAbsolutePower / etalonMass : 0
        };
    }
    return baseReturn;
}

// --- UI & RENDER FUNCTIONS ---
function updateUIFromState() {
    dom.riderMassSlider.value = appState.riderMass; dom.riderMassValue.textContent = `${appState.riderMass.toFixed(1)} kg`;
    dom.bikeMassSlider.value = appState.bikeMass; dom.bikeMassValue.textContent = `${appState.bikeMass.toFixed(1)} kg`;
    dom.crrSlider.value = appState.Crr; dom.crrValue.textContent = appState.Crr.toFixed(4);
    dom.cdaSlider.value = appState.CdA; dom.cdaValue.textContent = `${appState.CdA.toFixed(2)} m²`;
    dom.rhoSlider.value = appState.rho; dom.rhoValue.textContent = `${appState.rho.toFixed(2)} kg/m³`;
    dom.drivetrainLossSlider.value = appState.drivetrainLoss; dom.drivetrainLossValue.textContent = `${appState.drivetrainLoss.toFixed(1)} %`;
}

function renderPerformancesUI() {
    dom.performanceDataContainer.innerHTML = '';
    appState.performances.forEach((perf, index) => {
        const div = document.createElement('div');
        div.className = 'data-point-display';
        div.innerHTML = `<span>${perf.label}</span><button class="remove-point-btn" data-index="${index}">X</button>`;
        dom.performanceDataContainer.appendChild(div);
    });
    dom.performanceDataContainer.querySelectorAll('.remove-point-btn').forEach(btn => {
        btn.addEventListener('click', (e) => removePerformance(parseInt(e.target.dataset.index, 10)));
    });
}

function renderResultsTable() {
    let calculatedPerformances = appState.performances.map(p => calculatePerformance(p));
    
    calculatedPerformances.sort((a, b) => {
        let valA = a[appState.sortColumn] || -Infinity; let valB = b[appState.sortColumn] || -Infinity;
        if (typeof valA === 'string') return appState.sortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
        return appState.sortDirection === 'asc' ? valA - valB : valB - valA;
    });

    let tableHTML = '<table><thead><tr>';
    if (appState.mode === 'etalonToReal') {
        tableHTML += `
            ${getHeader('label', 'Label')}
            ${getHeader('lengthKm', 'Length (km)')}
            ${getHeader('elevationM', 'Elev. (m)')}
            ${getHeader('gradient', 'Gradient (%)')}
            ${getHeader('speedKmh', 'Speed (km/h)')}
            ${getHeader('VAM', 'VAM')}
            ${getHeader('durationS', 'Act. Time')}
            ${getHeader('durationS_expected', 'Exp.Time')}
            ${getHeader('timeDifferenceS', 'Time Diff.')}
            ${getHeader('effectiveWindMs', 'Eff. Wind (m/s)')}
            ${getHeader('etalonWkg', `Etal. W/kg`)}
            ${getHeader('realWkg', `W/kg (${appState.riderMass.toFixed(1)}kg)`)}
            ${getHeader('realAbsolutePower', 'Power (W)')}
        `;
    } else { // realToEtalon
        tableHTML += `
            ${getHeader('label', 'Label')}
            ${getHeader('absolutePower', `Real Power (W)`)}
            ${getHeader('realWkg', `Real W/kg (${appState.riderMass.toFixed(1)}kg)`)}
            ${getHeader('durationS', 'Duration')}
            ${getHeader('speedKmh', 'Speed (km/h)')}
            ${getHeader('VAM', 'VAM')}
            ${getHeader('gradient', 'Gradient (%)')}
            ${getHeader('etalonWkg', `Etalon W/kg`)}
            ${getHeader('etalonAbsolutePower', 'Etalon Power (W)')}
        `;
    }
    tableHTML += '</tr></thead><tbody>';

    calculatedPerformances.forEach(perf => {
        if (appState.mode === 'etalonToReal') {
            if (isNaN(perf.realWkg)) return;
            const timeDiffClass = perf.timeDifferenceS < 0 ? 'diff-positive' : 'diff-negative';
            const windClass = perf.effectiveWindMs < 0 ? 'diff-positive' : 'diff-negative';
            tableHTML += `
                <tr>
                    <td>${perf.label}</td>
                    <td>${perf.lengthKm.toFixed(2)}</td>
                    <td>${perf.elevationM.toFixed(0)}</td>
                    <td>${(perf.gradient * 100).toFixed(2)}</td>
                    <td>${perf.speedKmh.toFixed(2)}</td>
                    <td>${perf.VAM.toFixed(0)}</td>
                    <td>${formatDuration(perf.durationS)}</td>
                    <td>${formatDuration(perf.durationS_expected)}</td>
                    <td class="${timeDiffClass}">${perf.timeDifferenceS > 0 ? '+' : ''}${perf.timeDifferenceS.toFixed(1)}s</td>
                    <td class="${windClass}">${perf.effectiveWindMs.toFixed(2)}</td>
                    <td>${perf.etalonWkg.toFixed(2)}</td>
                    <td style="font-weight: bold;">${perf.realWkg.toFixed(2)}</td>
                    <td style="font-weight: bold;">${perf.realAbsolutePower.toFixed(0)}</td>
                </tr>`;
        } else { // realToEtalon
            if (isNaN(perf.etalonWkg)) return;
            tableHTML += `
                <tr>
                    <td>${perf.label}</td>
                    <td>${perf.absolutePower.toFixed(0)}</td>
                    <td>${perf.realWkg.toFixed(2)}</td>
                    <td>${formatDuration(perf.durationS)}</td>
                    <td>${perf.speedKmh.toFixed(2)}</td>
                    <td>${perf.VAM.toFixed(0)}</td>
                    <td>${(perf.gradient * 100).toFixed(2)}</td>
                    <td style="font-weight: bold;">${perf.etalonWkg.toFixed(2)}</td>
                    <td style="font-weight: bold;">${perf.etalonAbsolutePower.toFixed(0)}</td>
                </tr>`;
        }
    });
    tableHTML += `</tbody></table>`;
    dom.resultsTableContainer.innerHTML = tableHTML;
    document.querySelectorAll('#results-table-container th').forEach(th => {
        th.addEventListener('click', () => handleSort(th.dataset.column));
    });
}

// --- EVENT HANDLERS & HELPERS ---
function switchMode(newMode) {
    if (appState.mode === newMode) return;
    appState.mode = newMode;
    appState.performances = []; // Clear data on mode switch to avoid confusion
    
    dom.modeEtalonToRealBtn.classList.toggle('active', newMode === 'etalonToReal');
    dom.modeRealToEtalonBtn.classList.toggle('active', newMode === 'realToEtalon');
    
    const isEtalonToReal = newMode === 'etalonToReal';
    dom.etalonToRealInputs.style.display = isEtalonToReal ? 'block' : 'none';
    dom.realToEtalonInputs.style.display = isEtalonToReal ? 'none' : 'block';
    dom.explanationBoxWind.style.display = isEtalonToReal ? 'block' : 'none';
    dom.profileSelector.disabled = !isEtalonToReal;
    if (!isEtalonToReal) dom.profileSelector.value = "";
    dom.mainContentTitle.textContent = isEtalonToReal ? 'Performance Conversion Results' : 'Etalon Calculation from Real Power';
    
    appState.sortColumn = 'etalonWkg';
    appState.sortDirection = 'desc';
    updateAndRenderAll();
    renderPerformancesUI();
}

function openTab(evt, tabName) {
    let i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) { tabcontent[i].style.display = "none"; }
    tablinks = document.getElementsByClassName("tab-button");
    for (i = 0; i < tablinks.length; i++) { tablinks[i].className = tablinks[i].className.replace(" active", ""); }
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";
}

function addPerformance() {
    const label = dom.newPointLabelInput.value.trim();
    const lengthKm = parseFloat(dom.newPointLengthInput.value);
    const elevationM = parseFloat(dom.newPointElevationInput.value);
    let newPerf;

    if (label === "" || isNaN(lengthKm) || isNaN(elevationM) || lengthKm <= 0) {
        alert("Please provide a valid Label, Length (km > 0), and Elevation."); return;
    }

    if (appState.mode === 'etalonToReal') {
        const etalonWkg = parseFloat(dom.newPointEtalonWkgInput.value);
        const mins = parseInt(dom.newPointDurationMinInput.value) || 0;
        const secs = parseInt(dom.newPointDurationSecInput.value) || 0;
        const durationS = mins * 60 + secs;
        if (isNaN(etalonWkg) || durationS <= 0) {
            alert("Please provide a valid Etalon W/kg and an Actual Time (>0s)."); return;
        }
        newPerf = { label, lengthKm, elevationM, etalonWkg, durationS };
        dom.newPointEtalonWkgInput.value = ''; dom.newPointDurationMinInput.value = ''; dom.newPointDurationSecInput.value = '';

    } else { // realToEtalon
        const absolutePower = parseFloat(dom.newPointPowerInput.value);
        const mins = parseInt(dom.newPointPowerDurationMinInput.value) || 0;
        const secs = parseInt(dom.newPointPowerDurationSecInput.value) || 0;
        const durationS = mins * 60 + secs;
        if (isNaN(absolutePower) || durationS <= 0) {
            alert("Please provide valid Actual Power (W) and a Duration (>0s)."); return;
        }
        newPerf = { label, lengthKm, elevationM, absolutePower, durationS };
        dom.newPointPowerInput.value = ''; dom.newPointPowerDurationMinInput.value = ''; dom.newPointPowerDurationSecInput.value = '';
    }

    appState.performances.push(newPerf);
    updateAndRenderAll();
    renderPerformancesUI();
    dom.newPointLabelInput.value = ''; dom.newPointLengthInput.value = ''; dom.newPointElevationInput.value = '';
}

function removePerformance(index) {
    if (index >= 0 && index < appState.performances.length) {
        appState.performances.splice(index, 1);
        updateAndRenderAll();
        renderPerformancesUI();
    }
}

function saveProfile() {
    if (appState.mode !== 'etalonToReal') {
        alert("Saving profiles is only supported in 'Etalon -> Real Power' mode.");
        return;
    }
    const performancesToSave = appState.performances.map(p => ({
        label: p.label, lengthKm: p.lengthKm, elevationM: p.elevationM,
        etalonWkg: p.etalonWkg, durationS: p.durationS
    }));
    const profileData = {
        settings: {
            riderMass: appState.riderMass, bikeMass: appState.bikeMass, Crr: appState.Crr,
            CdA: appState.CdA, rho: appState.rho, drivetrainLoss: appState.drivetrainLoss
        },
        performances: performancesToSave
    };
    const profileString = JSON.stringify(profileData, null, 2);
    const blob = new Blob([profileString], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `etalon_profile_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
}

function loadProfile(event) {
    const file = event.target.files[0];
    if (!file) return;
    dom.loadedFileName.textContent = `Loading: ${file.name}`;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const loadedData = JSON.parse(e.target.result);
            if (!loadedData.settings || !Array.isArray(loadedData.performances)) throw new Error("Invalid profile format.");
            
            switchMode('etalonToReal'); // Loading a profile forces standard mode
            
            const { settings } = loadedData;
            appState.riderMass = settings.riderMass || appState.riderMass;
            appState.bikeMass = settings.bikeMass || appState.bikeMass;
            appState.Crr = settings.Crr || appState.Crr;
            appState.CdA = settings.CdA || appState.CdA;
            appState.rho = settings.rho || appState.rho;
            appState.drivetrainLoss = settings.drivetrainLoss || appState.drivetrainLoss;
            appState.performances = loadedData.performances;

            updateAndRenderAll();
            renderPerformancesUI();
            dom.loadedFileName.textContent = `Loaded: ${file.name}`;
        } catch (error) {
            alert(`Error loading profile: ${error.message}`);
            dom.loadedFileName.textContent = `Error loading file.`;
        } finally {
            dom.loadProfileInput.value = "";
        }
    };
    reader.readAsText(file);
}

function handleSort(columnKey) {
    if (appState.sortColumn === columnKey) {
        appState.sortDirection = appState.sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        appState.sortColumn = columnKey;
        appState.sortDirection = 'desc';
    }
    renderResultsTable();
}

function getHeader(columnKey, title) {
    let icon = appState.sortColumn === columnKey ? (appState.sortDirection === 'asc' ? '▲' : '▼') : '';
    return `<th data-column="${columnKey}">${title}<span class="sort-icon">${icon}</span></th>`;
}

function formatDuration(totalSeconds) {
    if (isNaN(totalSeconds) || totalSeconds < 0) return "N/A";
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = Math.round(totalSeconds % 60);
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
}

function loadProfileFromDropdown(profileKey) {
    const profile = PROFILES[profileKey];
    if (!profile) return;
    switchMode('etalonToReal'); // Example profiles are for standard mode
    Object.assign(appState, profile);
    appState.performances = JSON.parse(JSON.stringify(profile.performances));
    updateAndRenderAll();
    renderPerformancesUI();
}

function resetToDefault() {
    const defaultState = createInitialState();
    Object.assign(appState, defaultState);
    dom.profileSelector.value = "";
    switchMode('etalonToReal'); // Reset to default mode
}

function setupEventListeners() {
    dom.modeEtalonToRealBtn.addEventListener('click', () => switchMode('etalonToReal'));
    dom.modeRealToEtalonBtn.addEventListener('click', () => switchMode('realToEtalon'));

    const sliders = [
        { el: dom.riderMassSlider, stateKey: 'riderMass' }, { el: dom.bikeMassSlider, stateKey: 'bikeMass' },
        { el: dom.crrSlider, stateKey: 'Crr' }, { el: dom.cdaSlider, stateKey: 'CdA' },
        { el: dom.rhoSlider, stateKey: 'rho' }, { el: dom.drivetrainLossSlider, stateKey: 'drivetrainLoss' },
    ];
    sliders.forEach(s => s.el.addEventListener('input', () => {
        appState[s.stateKey] = parseFloat(s.el.value);
        updateAndRenderAll();
    }));

    dom.addPerformanceBtn.addEventListener('click', addPerformance);
    dom.profileSelector.addEventListener('change', (e) => {
        const selectedProfile = e.target.value;
        if (selectedProfile) { loadProfileFromDropdown(selectedProfile); } 
        else { resetToDefault(); }
    });
    dom.saveProfileBtn.addEventListener('click', saveProfile);
    dom.loadProfileTriggerBtn.addEventListener('click', () => dom.loadProfileInput.click());
    dom.loadProfileInput.addEventListener('change', loadProfile);
}

function updateAndRenderAll() {
    updateUIFromState();
    renderResultsTable();
}

function initializeApp() {
    document.querySelector('.tab-button').click();
    resetToDefault();
    setupEventListeners();
}

document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>