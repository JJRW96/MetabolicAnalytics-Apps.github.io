<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprint Metabolism Model v4.2 (Plotly Edition)</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Target layout colors - Using same color scheme as the reference app */
            --primary-color: #2683C6;
            --secondary-color: #42BA97;
            --accent-color: #EF5350; /* Red for termination */
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-color: #dee2e6;
            --gradient-start: #f1f8ff;
            --gradient-end: #ffffff;
            --white: #fff;
            --box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            --label-color: #555;
            --grid-color: rgba(200, 200, 200, 0.3);
            --tooltip-bg: rgba(50, 50, 50, 0.9);
            
            /* Colors for the plot matching reference app */
            --plot-pcr: #2683C6;      /* Blue - Primary */
            --plot-atp: #42BA97;      /* Green - Secondary */
            --plot-adp: #EF5350;      /* Red - Accent */
            --plot-amp: #FFA000;      /* Orange/Amber */
            --plot-la-rate: #6A1B9A;  /* Purple */
            --plot-la-m: #EC407A;     /* Pink */
        }

        /* Basic Styles - Matching reference app */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f5f5f5; color: var(--dark-color); line-height: 1.6; overflow: hidden; }
        .container { display: flex; height: 100vh; max-width: 100%; }

        /* Sidebar Styles - With scrollbar styling from reference app */
        .sidebar { 
            width: 360px; 
            flex-shrink: 0; 
            background: linear-gradient(to bottom, var(--gradient-start), var(--gradient-end)); 
            padding: 20px; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.1); 
            overflow-y: auto; 
            border-right: 1px solid var(--border-color); 
            max-height: 100vh; 
            position: relative; 
            z-index: 10; 
        }
        .sidebar::-webkit-scrollbar { width: 8px; }
        .sidebar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .sidebar::-webkit-scrollbar-thumb { background: #bbb; border-radius: 10px; }
        .sidebar::-webkit-scrollbar-thumb:hover { background: #999; }

        /* Main Content Styles */
        .main-content { flex: 1; padding: 20px; display: flex; flex-direction: column; background-color: var(--white); overflow-y: auto; }

        /* Headings */
        h1 { color: var(--primary-color); margin-bottom: 20px; font-size: 1.7rem; text-align: center; padding-bottom: 10px; border-bottom: 2px solid var(--border-color); }
        h2 { color: var(--dark-color); margin-bottom: 20px; font-size: 1.4rem; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }

        /* Control Groups (Cards) */
        .control-group { 
            margin-bottom: 15px; 
            border-bottom: 1px solid var(--border-color); 
            background-color: var(--white); 
            border-radius: 6px; 
            padding: 15px; 
            box-shadow: var(--box-shadow); 
            position: relative; 
        }
        .control-group:last-child { border-bottom: none; margin-bottom: 0; }

        /* Header Section with Title and Info Icon */
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .control-label {
            font-weight: 600;
            color: var(--dark-color);
            font-size: 1rem;
        }
        .info-icon {
            color: var(--primary-color);
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background-color: rgba(38, 131, 198, 0.1);
        }

        /* Tooltips (Info Boxes) - Repositioned to always stay in sidebar */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 240px;
            background-color: var(--tooltip-bg);
            color: var(--white);
            text-align: left;
            border-radius: 6px;
            padding: 10px 14px;
            position: absolute;
            z-index: 101;
            left: -280px; /* Position to the left of the info icon */
            top: 0;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9rem;
            line-height: 1.5;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* Parameter tooltips - These will be right-aligned in the sidebar */
        .parameter-tooltip {
            float: right;
            margin-left: 5px;
        }
        .parameter-tooltip .tooltiptext {
            left: auto;
            right: 30px;
            top: -5px;
        }

        /* Slider Label and Value */
        .slider-label { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            width: 100%; 
            margin-bottom: 5px; 
            font-weight: 500; 
            color: var(--label-color); 
            font-size: 0.95em; 
        }
        .slider-label label { margin-right: 10px; flex-shrink: 0; }
        .slider-value { 
            min-width: 75px; 
            text-align: right; 
            font-weight: bold; 
            color: var(--primary-color); 
            font-size: 0.95em; 
            white-space: nowrap; 
        }

        /* Custom Slider Styling - To match reference app */
        input[type="range"] {
            appearance: none; 
            -webkit-appearance: none; 
            width: 100%; 
            height: 8px; 
            border-radius: 5px;
            background: linear-gradient(to right, var(--primary-color) 0%, var(--primary-color) var(--value-percent, 50%), #ddd var(--value-percent, 50%), #ddd 100%);
            outline: none; 
            margin: 8px 0; 
            cursor: pointer; 
            transition: background 0.1s ease-in-out; 
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; 
            appearance: none; 
            width: 18px; 
            height: 18px; 
            border-radius: 50%;
            background: var(--primary-color); 
            cursor: pointer; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type="range"]::-moz-range-thumb {
            width: 18px; 
            height: 18px; 
            border-radius: 50%; 
            background: var(--primary-color);
            cursor: pointer; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3); 
            border: none;
        }
        input[type="range"]::-moz-range-track { 
            width: 100%; 
            height: 8px; 
            cursor: pointer; 
            background: #ddd; 
            border-radius: 5px; 
        }
        input[type="range"]::-moz-range-progress { 
            background-color: var(--primary-color); 
            height: 8px; 
            border-radius: 5px; 
        }

        /* Radio Buttons */
        .radio-label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 500; 
            color: var(--label-color); 
            font-size: 0.95em;
        }
        .radio-group, .unit-select-group { 
            display: flex; 
            flex-wrap: wrap; 
            margin-top: 8px; 
            padding: 10px; 
            background-color: rgba(38, 131, 198, 0.05); 
            border-radius: 4px; 
        }
        .radio-group label, .unit-select-group label { 
            font-weight: normal; 
            margin-right: 15px; 
            cursor: pointer; 
            display: inline-flex; 
            align-items: center; 
            margin-bottom: 5px; 
            font-size: 0.95em; 
        }
        .radio-group input[type="radio"], .unit-select-group input[type="radio"] { 
            margin-right: 8px; 
            cursor: pointer; 
            accent-color: var(--primary-color); 
        }

        /* Specific Groups & Hidden Class */
        #atp-consumption-direct-group, #atp-consumption-watt-group { 
            padding-left: 10px; 
            border-left: 3px solid var(--primary-color); 
            margin-top: 10px; 
            background-color: rgba(255, 255, 255, 0.5); 
        }
        .hidden { display: none !important; }

        /* Chart Container for Plotly */
        .plotly-chart-container {
            flex: 1; 
            min-height: 450px; 
            height: 600px; 
            background-color: var(--white);
            border-radius: 8px; 
            box-shadow: var(--box-shadow); 
            margin-bottom: 20px;
            padding: 15px; 
            position: relative;
        }

        /* Info Texts */
        .small-text { 
            display: block; 
            font-size: 0.85rem; 
            color: #666; 
            margin-top: 8px; 
            line-height: 1.4; 
        }
        .info-display { 
            font-size: 0.9em; 
            color: var(--secondary-color); 
            margin-top: 8px; 
            display: block; 
        }

        /* Buttons */
        button {
            background-color: var(--primary-color); 
            color: white; 
            border: none; 
            padding: 8px 15px;
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.3s;
            margin-top: 10px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            font-size: 0.9em;
        }
        button:hover { 
            background-color: #1a6eae; 
            transform: translateY(-1px); 
            box-shadow: 0 3px 5px rgba(0,0,0,0.15); 
        }
        button:active { transform: translateY(0); }

        /* Termination Threshold Slider Style */
        #termination-threshold-group input[type="range"] { 
            background: linear-gradient(to right, var(--accent-color) 0%, var(--accent-color) var(--value-percent, 65%), #ddd var(--value-percent, 65%), #ddd 100%); 
        }
        #termination-threshold-group input[type="range"]::-webkit-slider-thumb { 
            background: var(--accent-color); 
        }
        #termination-threshold-group input[type="range"]::-moz-range-thumb { 
            background: var(--accent-color); 
        }
        #termination-threshold-group .slider-value { 
            color: var(--accent-color); 
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="sidebar">
            <h1>Sprint Metabolism Model v4.2</h1>

            <div class="control-group">
                <div class="header-section">
                    <div class="control-label">Body Parameters</div>
                    <div class="tooltip info-icon">ⓘ
                        <span class="tooltiptext">Parameters related to the athlete's body mass and active muscle distribution.</span>
                    </div>
                </div>
                
                <!-- Total Body Mass Slider -->
                <div class="slider-container">
                    <div class="slider-label">
                        <label for="total_body_mass">Total Body Mass:</label>
                        <span class="slider-value"><span id="total_body_mass-value">70</span> kg</span>
                    </div>
                    <input type="range" id="total_body_mass" min="40" max="120" step="1" value="70">
                    <div class="parameter-tooltip tooltip info-icon">ⓘ
                        <span class="tooltiptext">Total body mass of the athlete (kg). Influences the calculation of absolute active muscle mass and the power (Watt) to ATP turnover conversion. [Ref: Heck PDF, p.51, 53, 486]</span>
                    </div>
                </div>

                <!-- Active Muscle Mass Slider -->
                <div class="slider-container">
                    <div class="slider-label">
                        <label for="active_mass_perc">Active Muscle Mass (%):</label>
                        <span class="slider-value"><span id="active_mass_perc-value">30</span> %</span>
                    </div>
                    <input type="range" id="active_mass_perc" min="10" max="50" step="1" value="30">
                    <div class="parameter-tooltip tooltip info-icon">ⓘ
                        <span class="tooltiptext">Estimated percentage of total body mass actively contracting during the sprint. Typically 20-40%. Affects Watt → ATP conversion and total PCr pool calculation. [Ref: Heck PDF, p.51, 53, 66, 231, 486, 503]</span>
                    </div>
                    <span class="info-display">Equals <span id="active_mass_kg_display">21.0</span> kg (at <span id="display_total_mass_ref">70</span> kg total)</span>
                </div>
            </div>

            <div class="control-group">
                <div class="header-section">
                    <div class="control-label">Initial Concentrations</div>
                    <div class="tooltip info-icon">ⓘ
                        <span class="tooltiptext">Initial concentrations of key metabolites in muscle tissue at the start of the sprint.</span>
                    </div>
                </div>
                
                <!-- PCr Initial Concentration Slider -->
                <div class="slider-container">
                    <div class="slider-label">
                        <label for="pcr0">PCr₀:</label>
                        <span class="slider-value"><span id="pcr0-value">23</span> mmol·kg⁻¹</span>
                    </div>
                    <input type="range" id="pcr0" min="10" max="30" step="0.5" value="23">
                    <div class="parameter-tooltip tooltip info-icon">ⓘ
                        <span class="tooltiptext">Initial muscle phosphocreatine concentration [mmol·kg⁻¹ wet muscle mass]. PCr rapidly buffers ATP via the Creatine Kinase reaction. Resting value typically ~23 mmol·kg⁻¹. [Ref: Heck PDF, p.54-55]</span>
                    </div>
                    <button id="set_pcr_default_btn" title="Estimate PCr₀ based on body weight and muscle mass">Estimate PCr₀</button>
                    <span class="info-display">Total PCr Pool (active): <span id="total_pcr_pool_display">483.0</span> mmol</span>
                </div>

                <!-- Pi Initial Concentration Slider -->
                <div class="slider-container">
                    <div class="slider-label">
                        <label for="pi0">Pᵢ₀:</label>
                        <span class="slider-value"><span id="pi0-value">3</span> mmol·kg⁻¹</span>
                    </div>
                    <input type="range" id="pi0" min="1" max="10" step="0.5" value="3">
                    <div class="parameter-tooltip tooltip info-icon">ⓘ
                        <span class="tooltiptext">Initial muscle inorganic phosphate concentration [mmol·kg⁻¹]. Typically 2-4 mmol·kg⁻¹ at rest. Increases as PCr is hydrolyzed. Part of Creatine Kinase equilibrium. [Ref: Heck PDF, p.54, 56]</span>
                    </div>
                </div>
            </div>

            <div class="control-group">
                <div class="header-section">
                    <div class="control-label">Equilibrium Constants</div>
                    <div class="tooltip info-icon">ⓘ
                        <span class="tooltiptext">Constants that determine the equilibrium reactions between key energy metabolites.</span>
                    </div>
                </div>
                
                <!-- Total Adenine Nucleotides Slider -->
                <div class="slider-container">
                    <div class="slider-label">
                        <label for="sa">S[A] (Total Adenine):</label>
                        <span class="slider-value"><span id="sa-value">7</span> mmol·kg⁻¹</span>
                    </div>
                    <input type="range" id="sa" min="5" max="10" step="0.1" value="7">
                    <div class="parameter-tooltip tooltip info-icon">ⓘ
                        <span class="tooltiptext">Total sum of Adenine Nucleotides (ATP+ADP+AMP) [mmol·kg⁻¹]. Assumed constant (~7 mmol·kg⁻¹) during short sprints as degradation via purine nucleotide cycle is negligible. [Ref: Heck PDF, p.54]</span>
                    </div>
                </div>

                <!-- Creatine Kinase Equilibrium Constant Slider -->
                <div class="slider-container">
                    <div class="slider-label">
                        <label for="m1">M₁ (at pH=7.0):</label>
                        <span class="slider-value"><span id="m1-value">166</span></span>
                    </div>
                    <input type="range" id="m1" min="50" max="400" step="1" value="166">
                    <div class="parameter-tooltip tooltip info-icon">ⓘ
                        <span class="tooltiptext">Creatine Kinase equilibrium constant ([ATP]/[ADP]) = M1 × ([PCr]/[Pi]). pH-dependent via M1 = [H+] × 1.66×10⁹ L/mol. M1 ≈ 166 at pH 7.0. [Ref: Heck PDF, p.54, Eq. 4.1b, 4.2]</span>
                    </div>
                </div>

                <!-- Adenylate Kinase Equilibrium Constant Slider -->
                <div class="slider-container">
                    <div class="slider-label">
                        <label for="m3">M₃:</label>
                        <span class="slider-value"><span id="m3-value">1.05</span></span>
                    </div>
                    <input type="range" id="m3" min="0.8" max="1.2" step="0.01" value="1.05">
                    <div class="parameter-tooltip tooltip info-icon">ⓘ
                        <span class="tooltiptext">Adenylate Kinase equilibrium constant ([ATP]×[AMP] = M3 × [ADP]²). Typically around 0.85-1.05. Links the concentrations of ATP, ADP, and AMP. [Ref: Heck PDF, p.54, Eq. 4.5]</span>
                    </div>
                </div>
            </div>

            <div class="control-group">
                <div class="header-section">
                    <div class="control-label">ATP Consumption</div>
                    <div class="tooltip info-icon">ⓘ
                        <span class="tooltiptext">Define how ATP is consumed during the sprint - either directly as a rate or calculated from mechanical power output.</span>
                    </div>
                </div>
                
                <!-- ATP Consumption Mode Radio Buttons -->
                <span class="radio-label">ATP Consumption Mode:</span>
                <div class="radio-group">
                    <label><input type="radio" name="atp_mode" value="direct" checked> Direct (mmol·kg⁻¹·s⁻¹)</label>
                    <label><input type="radio" name="atp_mode" value="watt"> Power (Watt)</label>
                </div>
                <div class="parameter-tooltip tooltip info-icon">ⓘ
                    <span class="tooltiptext">Select how energy demand is defined: Directly as ATP turnover [mmol·kg⁻¹·s⁻¹] or as mechanical power [Watt]. Watt value is converted using active muscle mass and efficiency factor. [Ref: Heck PDF, p.55, 63]</span>
                </div>
            </div>

            <!-- Direct ATP Consumption Group -->
            <div id="atp-consumption-direct-group" class="control-group">
                <div class="slider-container">
                    <div class="slider-label">
                        <label for="atp_consumption_direct">ATP Consumption (direct):</label>
                        <span class="slider-value"><span id="atp_consumption_direct-value">3</span> mmol·kg⁻¹·s⁻¹</span>
                    </div>
                    <input type="range" id="atp_consumption_direct" min="0.5" max="5" step="0.1" value="3">
                    <div class="parameter-tooltip tooltip info-icon">ⓘ
                        <span class="tooltiptext">Direct rate of ATP consumption by muscle contraction [mmol·kg⁻¹·s⁻¹]. Higher values indicate higher sprint intensity. Example in Fig 4.1 uses 3 mmol·kg⁻¹·s⁻¹. [Ref: Heck PDF, p.55]</span>
                    </div>
                </div>
            </div>

            <!-- Power-based ATP Consumption Group -->
            <div id="atp-consumption-watt-group" class="control-group hidden">
                <div class="slider-container">
                    <div class="slider-label">
                        <label for="atp_consumption_watt">Power:</label>
                        <span class="slider-value"><span id="atp_consumption_watt-value">1500</span> W</span>
                    </div>
                    <input type="range" id="atp_consumption_watt" min="300" max="3000" step="50" value="1500">
                    <div class="parameter-tooltip tooltip info-icon">ⓘ
                        <span class="tooltiptext">Mechanical power output [Watt]. Converted to ATP consumption/kg active muscle mass using factor ~0.05 mmol ATP/s/kg per W/kg (adjusted from literature). [Ref: Adapted from Heck PDF]</span>
                    </div>
                    <span class="info-display">Calculated Consumption: <span id="watt_equiv_atp_display">3.57</span> mmol·kg⁻¹·s⁻¹</span>
                    <small class="small-text">(Conversion factor: ~0.05 mmol·kg⁻¹·s⁻¹ per W/kg)</small>
                </div>
            </div>

            <div class="control-group">
                <div class="header-section">
                    <div class="control-label">Glycolytic Capacity</div>
                    <div class="tooltip info-icon">ⓘ
                        <span class="tooltiptext">The maximum rate at which lactate can be formed through glycolysis.</span>
                    </div>
                </div>
                
                <!-- Maximum Lactate Formation Rate Slider -->
                <div class="slider-container">
                    <div class="slider-label">
                        <label for="v_la_max">vLa_max:</label>
                        <span class="slider-value"><span id="v_la_max-value">60</span> <span id="v_la_max-unit">mmol·kg⁻¹·min⁻¹</span></span>
                    </div>
                    <input type="range" id="v_la_max" min="10" max="150" step="5" value="60">
                    <div class="parameter-tooltip tooltip info-icon">ⓘ
                        <span class="tooltiptext">Maximum rate of lactate formation (vGlyk_max / vLa_max) [mmol·kg⁻¹·min⁻¹ or mmol·L⁻¹·s⁻¹]. Reflects max glycolytic capacity. High in sprinters, low in endurance athletes. [Ref: Heck PDF, p.58, 72]</span>
                    </div>
                </div>
                
                <!-- vLa_max Unit Selection -->
                <span class="radio-label">Unit for vLa_max:</span>
                <div class="unit-select-group">
                    <label><input type="radio" name="la_unit" value="min" checked> mmol·kg⁻¹·min⁻¹</label>
                    <label><input type="radio" name="la_unit" value="L_s"> mmol·L⁻¹·s⁻¹</label>
                </div>
            </div>

            <!-- Termination Threshold Group -->
            <div id="termination-threshold-group" class="control-group">
                <div class="header-section">
                    <div class="control-label">Simulation Termination</div>
                    <div class="tooltip info-icon">ⓘ
                        <span class="tooltiptext">Controls when the simulation ends based on ATP depletion.</span>
                    </div>
                </div>
                
                <div class="slider-container">
                    <div class="slider-label">
                        <label for="termination_threshold_atp">Termination Threshold ATP:</label>
                        <span class="slider-value"><span id="termination_threshold_atp-value">65</span> % of ATP₀</span>
                    </div>
                    <input type="range" id="termination_threshold_atp" min="50" max="95" step="1" value="65">
                    <div class="parameter-tooltip tooltip info-icon">ⓘ
                        <span class="tooltiptext">Simulation stops when ATP concentration falls below this percentage of the initial ATP value (ATP₀). Simulates muscle contractile insufficiency due to low Free Energy of ATP hydrolysis (ΔG_ATP). Force generation is impaired below ~65% ATP₀. [Ref: Heck PDF, p.55-56, Fig 4.2]</span>
                    </div>
                </div>
            </div>

        </div>
        
        <div class="main-content">
            <h1>Sprint Metabolism Model (after Heck/Mader) v4.2</h1>

            <!-- Plotly chart container instead of Canvas -->
            <div id="sprintChart" class="plotly-chart-container"></div>
        </div>
    </div>

    <script>
        // Main function runs when DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Constants for the simulation
            const VOLREL = 0.75; // L water per kg muscle mass [Ref: Heck PDF, p.53]
            const KS2 = 0.15**3; // Glycolysis activation constant [Ref: Heck PDF, p.58, 120] (~0.003375 mmol/kgm)^3
            const WATT_TO_ATP_FACTOR = 0.05; // Adjusted factor mmol ATP/s/kgm per W/kgm
            const PC0_DEFAULT = 23; // Typical PCr0 resting value [mmol/kgm] [Ref: Heck PDF, p.55]
            const maxTime = 15.0; // Default max simulation time (seconds) - set to 20s as requested
            let terminationTime = null; // Global variable to track when simulation terminates

            // Get all DOM elements
            const sliders = {
                total_body_mass: document.getElementById('total_body_mass'),
                active_mass_perc: document.getElementById('active_mass_perc'),
                pcr0: document.getElementById('pcr0'), 
                pi0: document.getElementById('pi0'),
                sa: document.getElementById('sa'), 
                m1: document.getElementById('m1'),
                m3: document.getElementById('m3'),
                atp_consumption_direct: document.getElementById('atp_consumption_direct'),
                atp_consumption_watt: document.getElementById('atp_consumption_watt'),
                v_la_max: document.getElementById('v_la_max'),
                termination_threshold_atp: document.getElementById('termination_threshold_atp')
            };
            
            const values = {
                total_body_mass: document.getElementById('total_body_mass-value'),
                active_mass_perc: document.getElementById('active_mass_perc-value'),
                pcr0: document.getElementById('pcr0-value'), 
                pi0: document.getElementById('pi0-value'),
                sa: document.getElementById('sa-value'), 
                m1: document.getElementById('m1-value'),
                m3: document.getElementById('m3-value'),
                atp_consumption_direct: document.getElementById('atp_consumption_direct-value'),
                atp_consumption_watt: document.getElementById('atp_consumption_watt-value'),
                v_la_max: document.getElementById('v_la_max-value'),
                termination_threshold_atp: document.getElementById('termination_threshold_atp-value')
            };
            
            const displays = {
                display_total_mass_ref: document.getElementById('display_total_mass_ref'),
                active_mass_kg: document.getElementById('active_mass_kg_display'),
                total_pcr_pool: document.getElementById('total_pcr_pool_display'),
                v_la_max_unit: document.getElementById('v_la_max-unit'),
                watt_equiv_atp: document.getElementById('watt_equiv_atp_display')
            };
            
            const radioGroups = {
                atp_mode: document.querySelectorAll('input[name="atp_mode"]'),
                la_unit: document.querySelectorAll('input[name="la_unit"]')
            };
            
            const controlGroups = {
                directATP: document.getElementById('atp-consumption-direct-group'),
                wattATP: document.getElementById('atp-consumption-watt-group')
            };
            
            const buttons = {
                set_pcr_default: document.getElementById('set_pcr_default_btn')
            };

            // Update slider background gradient based on value position
            function updateSliderBackground(slider) {
                if (!slider) return;
                try {
                    const min = parseFloat(slider.min);
                    const max = parseFloat(slider.max);
                    const val = parseFloat(slider.value);
                    const percentage = ((val - min) / (max - min)) * 100;
                    slider.style.setProperty('--value-percent', `${percentage}%`);
                } catch (e) { 
                    console.error("Error updating slider background:", e); 
                }
            }

            // Estimate PCr concentration based on body composition
            // This function calculates PCr based on body mass and active muscle percentage
            // PCr tends to be higher in more muscular individuals and lower in less active ones
            function estimatePCr(bodyMass, activeMassPerc) {
                // Base value - typical healthy adult
                const basePCr = 23; // mmol/kg
                
                // Factors that influence PCr concentration
                const massAdjustment = (bodyMass - 70) * 0.02; // Small adjustment based on total mass
                const muscleAdjustment = (activeMassPerc - 30) * 0.1; // Larger adjustment for muscle percentage
                
                // Calculate estimated PCr, ensuring it stays within physiological limits
                let estimatedPCr = basePCr + massAdjustment + muscleAdjustment;
                
                // Constrain to physiological range (15-30 mmol/kg)
                estimatedPCr = Math.max(15, Math.min(30, estimatedPCr));
                
                return estimatedPCr;
            }

            // Plot color definitions matching reference app
            const plotColors = {
                pcr: '#2683C6',    // Primary color (blue)
                atp: '#42BA97',    // Secondary color (teal)
                adp: '#EF5350',    // Accent color (red)
                amp: '#FFA000',    // Orange/Amber
                la_rate: '#6A1B9A', // Purple
                la_m: '#EC407A'    // Pink
            };

            // Main calculation function - computes all metabolic values
            const calculateMetabolism = (params) => {
                // Extract parameters needed for calculation
                const { 
                    PCr0, Pi0, SA, M1, M3, ActiveMassKg, 
                    ATPConsumptionMode, ATPConsumptionDirect, ATPConsumptionWatt, 
                    vLa_max_input, LaRateUnit, terminationThresholdATP 
                } = params;
                
                const SC = PCr0 + Pi0; // Total phosphate pool
                terminationTime = null; // Reset global termination time

                // Calculate ATP consumption rate based on selected mode
                let ATP_consumption_calc;
                if (ATPConsumptionMode === 'direct') {
                    ATP_consumption_calc = ATPConsumptionDirect;
                } else {
                    // Convert from watts to ATP consumption rate
                    const wattPerKgm = ActiveMassKg > 0 ? ATPConsumptionWatt / ActiveMassKg : 0;
                    ATP_consumption_calc = wattPerKgm * WATT_TO_ATP_FACTOR;
                }

                // Convert vLa_max to consistent units (per second)
                // This conversion ensures vLa_max is physiologically reasonable (0.3-1.5 range)
                let vLa_max_per_kgm_s;
                if (LaRateUnit === 'min') { 
                    vLa_max_per_kgm_s = vLa_max_input / 60.0; // Convert from per minute to per second
                } else { 
                    // Convert from per L to per kgm with the physiological volume relation factor
                    vLa_max_per_kgm_s = vLa_max_input * VOLREL; 
                }

                // Simulation parameters
                const timeStep = 0.05; // seconds - small steps for accuracy
                let time = 0, PCr = PCr0, Pi = Pi0, ATP = 0, ADP = 0, AMP = 0, La_m = 0.5;
                let ATP0 = 0;
                
                // Arrays to store results over time
                const results = { 
                    time: [], pcr: [], atp: [], adp: [], amp: [], la_rate: [], la_m: [] 
                };

                // Calculate initial state based on equilibrium constants
                let Q_t0 = (PCr > 1e-9 && Pi > 1e-9) ? M1 * PCr / Pi : 0;
                if (Q_t0 > 1e-9) {
                    ADP = (SA * Q_t0) / (M3 + Q_t0 + Q_t0**2);
                    ATP = ADP * Q_t0;
                    AMP = SA - ATP - ADP;
                } else { 
                    // Default values if equilibrium can't be calculated
                    ATP = SA * 0.98; 
                    ADP = SA * 0.019; 
                    AMP = SA * 0.001; 
                }
                
                // Ensure values are within valid ranges
                ATP = Math.max(1e-9, Math.min(SA, ATP));
                ADP = Math.max(0, Math.min(SA - ATP, ADP));
                AMP = Math.max(0, SA - ATP - ADP);
                ATP0 = ATP; // Store initial ATP value for termination threshold

                // Record initial state
                results.time.push(time);
                results.pcr.push(PCr);
                results.atp.push(ATP);
                results.adp.push(ADP);
                results.amp.push(AMP);
                results.la_rate.push(0);
                results.la_m.push(La_m);

                // Main simulation loop
                while (time < maxTime) {
                    time += timeStep;
                    
                    // Calculate ATP consumed during this time step
                    const atpNeeded = ATP_consumption_calc * timeStep;
                    
                    // PCr is used to resynthesize ATP
                    let pcrUsed = (PCr > 0) ? Math.min(PCr, atpNeeded) : 0;
                    PCr = Math.max(0, PCr - pcrUsed);
                    Pi = Math.max(1e-9, SC - PCr);

                    // Recalculate equilibrium state based on new PCr and Pi values
                    let Q = (Pi > 1e-9 && PCr > 1e-9) ? M1 * PCr / Pi : (PCr <= 1e-9 ? 1e-9 : 0);
                    
                    if (Q >= 1e-9) {
                        // Normal equilibrium calculation
                        ADP = (SA * Q) / (M3 + Q + Q**2);
                        ATP = ADP * Q;
                        AMP = SA - ATP - ADP;
                    } else if (PCr <= 1e-9) {
                        // PCr depletion case
                        ADP = SA / (1 + M3);
                        ATP = 1e-9;
                        AMP = SA - ADP;
                    } else {
                        // Fallback case (shouldn't normally occur)
                        ATP = SA * 0.98;
                        ADP = SA * 0.019;
                        AMP = SA * 0.001;
                    }
                    
                    // Ensure values remain within valid ranges
                    ATP = Math.max(1e-9, Math.min(SA, ATP));
                    ADP = Math.max(0, Math.min(SA - ATP, ADP));
                    AMP = Math.max(0, SA - ATP - ADP);

                    // Calculate lactate formation rate based on ADP concentration
                    // This follows the ADP-dependent activation model from Mader
                    let v_La_rate_kgm_s = (ADP > 1e-9) ? 
                        vLa_max_per_kgm_s * (ADP**3) / (KS2 + ADP**3) : 0;
                    v_La_rate_kgm_s = Math.max(0, v_La_rate_kgm_s);
                    
                    // Accumulate lactate over time
                    La_m = Math.max(0, La_m + v_La_rate_kgm_s * timeStep);
                    
                    // Convert rate to selected output units
                    let v_La_rate_output = (LaRateUnit === 'min') ? 
                        v_La_rate_kgm_s * 60.0 : v_La_rate_kgm_s / VOLREL;

                    // Record current state
                    results.time.push(time);
                    results.pcr.push(PCr);
                    results.atp.push(ATP);
                    results.adp.push(ADP);
                    results.amp.push(AMP);
                    results.la_rate.push(v_La_rate_output);
                    results.la_m.push(La_m);

                    // Check termination condition - using ATP percentage as in Heck PDF
                    if (ATP < (terminationThresholdATP / 100) * ATP0) {
                        terminationTime = time; // Set global termination time
                        console.log(`Simulation terminated at t=${time.toFixed(2)}s, ATP = ${ATP.toFixed(3)} (Threshold: ${((terminationThresholdATP / 100) * ATP0).toFixed(3)})`);
                        break; // Exit loop
                    }
                }
                
                return results;
            };

            // Update the Plotly chart with new data
            const updateChart = () => {
                // 1. Read current parameter values from sliders
                const totalBodyMass = parseFloat(sliders.total_body_mass?.value || 70);
                const activeMassPerc = parseFloat(sliders.active_mass_perc?.value || 30);
                const activeMassKg = (activeMassPerc / 100) * totalBodyMass;
                const currentPCr0 = parseFloat(sliders.pcr0?.value || PC0_DEFAULT);
                const selectedATPMode = document.querySelector('input[name="atp_mode"]:checked')?.value || 'direct';
                const selectedLaUnit = document.querySelector('input[name="la_unit"]:checked')?.value || 'min';
                const terminationThresholdATP = parseFloat(sliders.termination_threshold_atp?.value || 65);

                // 2. Update displayed values in UI
                if (values.total_body_mass) values.total_body_mass.textContent = totalBodyMass;
                if (values.active_mass_perc) values.active_mass_perc.textContent = activeMassPerc;
                if (displays.active_mass_kg) displays.active_mass_kg.textContent = activeMassKg.toFixed(1);
                if (displays.display_total_mass_ref) displays.display_total_mass_ref.textContent = totalBodyMass;
                if (displays.total_pcr_pool) displays.total_pcr_pool.textContent = (currentPCr0 * activeMassKg).toFixed(1);
                
                // Update all slider displays and backgrounds
                for (const key in sliders) {
                    if (sliders[key] && values[key]) { 
                        values[key].textContent = sliders[key].value; 
                        updateSliderBackground(sliders[key]); 
                    }
                }
                
                // Update unit display for Lactate with correct notation
                if (displays.v_la_max_unit) {
                    displays.v_la_max_unit.textContent = (selectedLaUnit === 'min') ? 'mmol·kg⁻¹·min⁻¹' : 'mmol·L⁻¹·s⁻¹';
                }

                // 3. Toggle ATP mode UI elements based on selection
                if (controlGroups.directATP && controlGroups.wattATP && displays.watt_equiv_atp) {
                    if (selectedATPMode === 'direct') {
                        controlGroups.directATP.classList.remove('hidden'); 
                        controlGroups.wattATP.classList.add('hidden');
                        displays.watt_equiv_atp.textContent = '---';
                    } else {
                        controlGroups.directATP.classList.add('hidden'); 
                        controlGroups.wattATP.classList.remove('hidden');
                        
                        // Calculate and display ATP consumption from watts with updated factor
                        const wattValue = parseFloat(sliders.atp_consumption_watt?.value || 1500);
                        const wattPerKgm = activeMassKg > 0 ? wattValue / activeMassKg : 0;
                        const equivATP = wattPerKgm * WATT_TO_ATP_FACTOR;
                        displays.watt_equiv_atp.textContent = equivATP.toFixed(2);
                    }
                }

                // 4. Prepare parameters for simulation
                const currentParams = {
                    PCr0: currentPCr0, 
                    Pi0: parseFloat(sliders.pi0?.value || 3),
                    SA: parseFloat(sliders.sa?.value || 7), 
                    M1: parseFloat(sliders.m1?.value || 166),
                    M3: parseFloat(sliders.m3?.value || 1.05), 
                    ActiveMassKg: activeMassKg,
                    ATPConsumptionMode: selectedATPMode,
                    ATPConsumptionDirect: parseFloat(sliders.atp_consumption_direct?.value || 3),
                    ATPConsumptionWatt: parseFloat(sliders.atp_consumption_watt?.value || 1500),
                    vLa_max_input: parseFloat(sliders.v_la_max?.value || 60), 
                    LaRateUnit: selectedLaUnit,
                    terminationThresholdATP: terminationThresholdATP
                };

                // 5. Run the metabolism calculation
                const results = calculateMetabolism(currentParams);

                // 6. Prepare data for Plotly
                // Create data traces for all metabolites
                const plotData = [
                    {
                        x: results.time,
                        y: results.pcr,
                        name: 'PCr (mmol·kg⁻¹)',
                        line: {
                            color: plotColors.pcr,
                            width: 3
                        },
                        yaxis: 'y'
                    },
                    {
                        x: results.time,
                        y: results.atp,
                        name: 'ATP (mmol·kg⁻¹)',
                        line: {
                            color: plotColors.atp,
                            width: 3
                        },
                        yaxis: 'y'
                    },
                    {
                        x: results.time,
                        y: results.adp,
                        name: 'ADP (mmol·kg⁻¹)',
                        line: {
                            color: plotColors.adp,
                            width: 3
                        },
                        yaxis: 'y'
                    },
                    {
                        x: results.time,
                        y: results.amp,
                        name: 'AMP (mmol·kg⁻¹)',
                        line: {
                            color: plotColors.amp,
                            width: 3
                        },
                        yaxis: 'y'
                    },
                    {
                        x: results.time,
                        y: results.la_rate,
                        name: `Lactate Formation Rate (${selectedLaUnit === 'min' ? 'mmol·kg⁻¹·min⁻¹' : 'mmol·L⁻¹·s⁻¹'})`,
                        line: {
                            color: plotColors.la_rate,
                            width: 2.5,
                            dash: 'dash'
                        },
                        yaxis: 'y2'
                    },
                    {
                        x: results.time,
                        y: results.la_m,
                        name: 'Muscle Lactate (mmol·kg⁻¹)',
                        line: {
                            color: plotColors.la_m,
                            width: 3
                        },
                        yaxis: 'y'
                    }
                ];

                // Calculate appropriate axis ranges
                const maxPCr = Math.max(...results.pcr);
                const maxConcData = Math.max(
                    maxPCr,
                    Math.max(...results.atp), 
                    Math.max(...results.adp), 
                    Math.max(...results.amp), 
                    Math.max(...results.la_m)
                );
                
                // Set max concentration to 30 or PCr*1.2 if higher, per requirements
                const maxConc = Math.max(30, maxPCr * 1.2);
                
                const maxRate = Math.max(
                    10,
                    Math.max(...results.la_rate) * 1.1
                );
                
                // Determine x-axis range: 20s or termination time + 10% if later
                const xAxisMax = terminationTime ? 
                    Math.max(15, terminationTime * 1.1) : 
                    15;
                
                // Setup termination marker if applicable
                let shapes = [];
                if (terminationTime !== null) {
                    shapes.push({
                        type: 'line',
                        x0: terminationTime,
                        y0: 0,
                        x1: terminationTime,
                        y1: maxConc,
                        line: {
                            color: plotColors.adp,
                            width: 2,
                            dash: 'dash'
                        }
                    });
                }

                // Create layout for Plotly with legend between title and chart
                const plotLayout = {
                    title: {
                        text: 'Muscle Sprint Metabolism Simulation',
                        font: {
                            size: 20,
                            color: plotColors.pcr
                        }
                    },
                    xaxis: {
                        title: {
                            text: 'Time (s)',
                            font: {
                                size: 14
                            }
                        },
                        range: [0, xAxisMax]
                    },
                    yaxis: {
                        title: {
                            text: 'Concentration (mmol·kg⁻¹)',
                            font: {
                                size: 14
                            }
                        },
                        range: [0, maxConc]
                    },
                    yaxis2: {
                        title: {
                            text: `Lactate Formation Rate (${selectedLaUnit === 'min' ? 'mmol·kg⁻¹·min⁻¹' : 'mmol·L⁻¹·s⁻¹'})`,
                            font: {
                                size: 14
                            }
                        },
                        range: [0, maxRate],
                        overlaying: 'y',
                        side: 'right'
                    },
                    shapes: shapes,
                    annotations: terminationTime ? [{
                        x: terminationTime,
                        y: maxConc * 0.95,
                        text: `Termination: ${terminationTime.toFixed(2)}s`,
                        showarrow: true,
                        arrowhead: 2,
                        arrowcolor: plotColors.adp,
                        ax: -30,
                        ay: -30
                    }] : [],
                    legend: {
                        orientation: 'h',
                        y: 1.05,
                        x: 0.5,
                        xanchor: 'center'
                    },
                    grid: {rows: 1, columns: 1, pattern: 'independent'},
                    margin: {l: 60, r: 60, t: 80, b: 60},
                    plot_bgcolor: '#fff',
                    paper_bgcolor: '#fff',
                    hovermode: 'closest'
                };

                // Create Plotly configuration
                const plotConfig = {
                    responsive: true,
                    displayModeBar: true,
                    modeBarButtonsToRemove: ['lasso2d', 'select2d']
                };

                // Render the plot using Plotly
                Plotly.newPlot('sprintChart', plotData, plotLayout, plotConfig);
            };

            // Set up event listeners for all input elements
            
            // Add listeners to all sliders
            Object.values(sliders).forEach(slider => {
                if (slider) { 
                    slider.addEventListener('input', updateChart); 
                    updateSliderBackground(slider); 
                }
            });
            
            // Add listeners to radio buttons
            radioGroups.atp_mode.forEach(radio => 
                radio?.addEventListener('change', updateChart)
            );
            
            radioGroups.la_unit.forEach(radio => 
                radio?.addEventListener('change', updateChart)
            );
            
            // Add listener to PCr default button - now uses body composition
            buttons.set_pcr_default?.addEventListener('click', () => {
                if (sliders.pcr0) { 
                    const bodyMass = parseFloat(sliders.total_body_mass?.value || 70);
                    const activeMassPerc = parseFloat(sliders.active_mass_perc?.value || 30);
                    
                    // Calculate PCr based on body composition
                    const estimatedPCr = estimatePCr(bodyMass, activeMassPerc);
                    
                    // Update slider value
                    sliders.pcr0.value = estimatedPCr.toFixed(1);
                    updateChart();
                }
            });

            // Initialize the chart on page load
            updateChart();
            
            // Handle window resize to make the chart responsive
            window.addEventListener('resize', () => {
                Plotly.relayout('sprintChart', {
                    width: document.getElementById('sprintChart').clientWidth,
                    height: document.getElementById('sprintChart').clientHeight
                });
            });
        });
    </script>

</body>
</html>